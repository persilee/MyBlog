---
title: Androidå“åº”å¼ç¼–ç¨‹ä¹‹RxJava
tags:
  - Java
  - RxJava
copyright: true
comments: true
date: 2020-08-04 15:19:44
categories: Java
top: 121
photos:
---

{% li https://cdn.lishaoy.net/rxjava/rxjava_cover.png, RxJava,RxJava %}

æœ¬ç¯‡æ–‡ç« å°†æ¦‚è¿° **Android** å“åº”å¼ç¼–ç¨‹ **RxJava**ï¼Œä¼šä»è®¾è®¡æ¨¡å¼ã€ä½¿ç”¨åˆ°åŸç†ç»“åˆæ¡ˆä¾‹ï¼Œç”±æµ…åˆ°æ·±ã€ç”±è¡¨åˆ°é‡Œã€å¾ªåºæ¸è¿›çš„æ¦‚è¿°ã€‚

<hr />

<!-- more -->

## è§‚å¯Ÿè€…æ¨¡å¼(Observer pattern)

åœ¨ä½¿ç”¨ **RxJava** ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆç†è§£è§‚å¯Ÿè€…è®¾è®¡æ¨¡å¼ï¼Œå› ä¸ºï¼Œ**RxJava** å°±ä½¿ç”¨äº†è§‚å¯Ÿè€…è®¾è®¡æ¨¡å¼ã€‚

### å®šä¹‰

è§‚å¯Ÿè€…æ¨¡å¼(åˆè¢«ç§°ä¸ºå‘å¸ƒ-è®¢é˜… Publish/Subscribe æ¨¡å¼)ï¼Œå±äºè¡Œä¸ºå‹æ¨¡å¼çš„ä¸€ç§ï¼Œå®ƒå®šä¹‰äº†ä¸€å¯¹å¤šçš„ä¾èµ–å…³ç³»ï¼Œè®©å¤šä¸ªè§‚å¯Ÿè€…å¯¹è±¡åŒæ—¶ç›‘å¬æŸä¸€ä¸ªè¢«è§‚å¯Ÿè€…å¯¹è±¡ï¼Œè¢«è§‚å¯Ÿè€…å¯¹è±¡åœ¨çŠ¶æ€å˜åŒ–æ—¶ï¼Œä¼šé€šçŸ¥æ‰€æœ‰çš„è§‚å¯Ÿè€…å¯¹è±¡ï¼Œä½¿ä»–ä»¬èƒ½å¤Ÿè‡ªåŠ¨æ›´æ–°ã€‚

### ç»“æ„

è§‚å¯Ÿè€…æ¨¡å¼ç»“æ„ï¼Œå¦‚å›¾ï¼š

<div style="width: 100%; margin:auto">

![no-shadow](https://cdn.lishaoy.net/rxjava/UML.png "UML")

</div>

ä¸€èˆ¬æˆ‘ä»¬å†™ä¸€ä¸ªè§‚å¯Ÿè€…æ¨¡å¼éƒ½éœ€è¦å®šä¹‰å¦‚ä¸‹è§’è‰²ï¼š

- Observable(è¢«è§‚å¯Ÿè€…)ï¼šä¸€èˆ¬ä¸ºæŠ½è±¡ç±»ï¼Œç”¨äºä¿å­˜è§‚å¯Ÿè€…å¯¹è±¡å’Œæ–°å¢ã€åˆ é™¤ã€é€šçŸ¥è§‚å¯Ÿè€…çš„æ–¹æ³•ã€‚
- ConcreteObservable(å…·ä½“çš„è¢«è§‚å¯Ÿè€…)ï¼šç»§æ‰¿ Observable ç±»ï¼Œå®ç° `notifyObservers()` æ–¹æ³•ï¼Œå½“è¢«è§‚å¯Ÿè€…å‘ç”Ÿå˜åŒ–æ—¶ï¼Œé€šçŸ¥æ‰€æœ‰çš„è§‚å¯Ÿè€…ã€‚
- Observer(è§‚å¯Ÿè€…)ï¼šä¸€èˆ¬ä¸ºæ¥å£ï¼ŒåŒ…å« `update()` æ–¹æ³•ï¼Œå½“æ”¶åˆ°å…·ä½“çš„è¢«è§‚å¯Ÿè€…é€šçŸ¥æ—¶è¢«è°ƒç”¨ã€‚
- ConcreteObserver(å…·ä½“çš„è§‚å¯Ÿè€…)ï¼šå®ç° Observer æ¥å£ï¼Œé‡å†™ `update()` æ–¹æ³•ï¼Œä»¥ä¾¿æ›´æ–°è‡ªèº«çŠ¶æ€ã€‚

### æ¡ˆä¾‹

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥å®ç°ä¸€ä¸ªç®€å•çš„è§‚å¯Ÿè€…æ¨¡å¼çš„æ¡ˆä¾‹ï¼Œæ¡ˆä¾‹æƒ…æ™¯ï¼Œå¦‚ä¸‹ï¼š

{% note info %} å°æ˜çš„æ°´æœåº—é‡Œçš„ ğŸŠ éå¸¸ç”œï¼Œæ‰€ä»¥å¾ˆå¿«å°±å–å…‰äº†ï¼Œä½†æ˜¯ï¼Œæ¥äºŒè¿ä¸‰çš„æœ‰é¡¾å®¢è¿‡æ¥ä¹° ğŸŠï¼Œäºæ˜¯ï¼Œå°æ˜å‘Šè¯‰é¡¾å®¢ï¼šğŸŠå·²ç»å–å®Œäº†ï¼Œä½ ä»¬å¯ä»¥æ‰«ä¸‹è¿™ä¸ªå…¬ä¼—å·ï¼Œè®¢é˜…ä¹‹åï¼Œç­‰ ğŸŠæœ‰è´§äº†ä¼šè‡ªåŠ¨é€šçŸ¥ä½ ä»¬ï¼ {% endnote %}

è¿™ç§åœºæ™¯æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼ï¼Œæˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ª `Observer` æ¥å£(è§‚å¯Ÿè€…)ï¼Œå¦‚ä¸‹ï¼š

```java
public interface Observer {
    void update();
}
```

å†åˆ›å»ºä¸€ä¸ª `Customer` å®¢æˆ·ç±»(å…·ä½“çš„è§‚å¯Ÿè€…)ï¼Œå¦‚ä¸‹ï¼š

```java
// å®ç° Observer æ¥å£
public class Customer implements Observer {

    private String name;

    public Customer(String name) {
        this.name = name;
    }

    // é‡æ–° Observer çš„ update() æ–¹æ³•
    @Override
    public void update() {
        System.out.println(name + " è´­ä¹°äº† ğŸŠ");
    }
}
```

ä¹‹ååˆ›å»ºä¸€ä¸ª `Observable` æŠ½è±¡ç±»(è¢«è§‚å¯Ÿè€…)ï¼Œå¦‚ä¸‹ï¼š

```java
public abstract class Observable {
    // è§‚å¯Ÿè€…
    protected List<Observer> observers = new ArrayList<>();
    // æ–°å¢è§‚å¯Ÿè€…
    public void add(Observer observer) {
        observers.add(observer);
    }
    // ç§»é™¤è§‚å¯Ÿè€…
    public void remove(Observer observer) {
        observers.remove(observer);
    }
    // é€šçŸ¥è§‚å¯Ÿè€…
    public abstract void notifyObservers();
}
```

æœ€ååˆ›å»ºä¸€ä¸ª `FruitStore` æ°´æœåº—ç±»(å…·ä½“çš„è¢«è§‚å¯Ÿè€…)ï¼Œå¦‚ä¸‹ï¼š

```java
// ç»§æ‰¿ Observable ç±»
public class FruitStore extends Observable {
    // é‡å†™ notifyObservers() é€šçŸ¥æ‰€æœ‰çš„è§‚å¯Ÿè€…
    @Override
    public void notifyObservers() {
        for (Observer observer: observers) {
            observer.update();
        }
    }

    public void run() {
        this.notifyObservers();
    }
}
```

æˆ‘ä»¬å†åˆ›å»ºä¸€ä¸ª `Client` è¿›è¡Œæµ‹è¯•ï¼Œå¦‚ä¸‹ï¼š

```java
public class Client {
    public static void main(String[] args) {
        // åˆ›å»ºä¸€ä¸ªæ°´æœåº—å®ä¾‹(è¢«è§‚å¯Ÿè€…)
        FruitStore fruitStore = new FruitStore();
        fruitStore.add(new Customer("lsy")); // æ–°å¢è§‚å¯Ÿè€…
        fruitStore.add(new Customer("per")); // æ–°å¢è§‚å¯Ÿè€…
        fruitStore.add(new Customer("zimu")); // æ–°å¢è§‚å¯Ÿè€…
        fruitStore.run(); // é€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…
    }
}
```

è¿è¡Œç»“æœå¦‚ä¸‹ï¼š

```bash
lsy è´­ä¹°äº† ğŸŠ
per è´­ä¹°äº† ğŸŠ
zimu è´­ä¹°äº† ğŸŠ

Process finished with exit code 0
```

å¯è§ï¼Œä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼å¯ä»¥é™ä½è§‚å¯Ÿè€…å’Œè¢«è§‚å¯Ÿè€…ä¹‹é—´çš„è€¦åˆæ€§ï¼Œå¯ä»¥å»ºç«‹ä¸€å¥—è§¦å‘æœºåˆ¶ï¼›å½“ç„¶ï¼ŒJava JDK å·²ç»æä¾›äº† `Observer`ã€`Observable`ï¼Œæˆ‘ä»¬ä½¿ç”¨å®ƒä»¬åŒæ ·å¯ä»¥å®ç°åŠŸèƒ½ã€‚

## RxJavaçš„ä½¿ç”¨

é€šè¿‡ä¸Šæ–‡çš„å¯¹è§‚å¯Ÿè€…æ¨¡å¼çš„ç†è§£ä¹‹åï¼Œå†æ¥çœ‹çœ‹ **RxJava** æ˜¯å¦‚ä½•ä½¿ç”¨çš„ï¼Œå®ƒåŒæ ·æœ‰å¦‚ä¸‹å‡ ä¸ªè§’è‰²ï¼Œå¦‚ä¸‹ï¼š

- Observable : è¢«è§‚å¯Ÿè€…ï¼Œä¹Ÿå°±æ˜¯äº‹ä»¶çš„å‘ç”Ÿè€…
- Observerï¼šè§‚å¯Ÿè€…ï¼Œä¹Ÿå°±æ˜¯äº‹ä»¶çš„æ¥å—è€…
- subscribeï¼šä¸¤è€…äº§ç”Ÿè®¢é˜…å…³ç³»

å…·ä½“çš„ä½¿ç”¨å¦‚ä¸‹ï¼š

```java
public class UseRxJava {

    public static void main(String[] args) {
        // åˆ›å»º Observable è¢«è§‚å¯Ÿè€…
        Observable observable = Observable.create(new ObservableOnSubscribe<String>() {
            @Override
            public void subscribe(@NonNull ObservableEmitter<String> emitter) throws Throwable {
                emitter.onNext("ğŸŠ åˆ°è´§äº†ï¼");
                emitter.onNext("å¤§å®¶å¯ä»¥æ¥ä¹° ğŸŠ äº†ï¼");
                emitter.onError(new Throwable("ğŸŠ åˆå–å®Œäº†ï¼"));
                emitter.onNext("WOWï¼ğŸŠ å–å…‰äº†");
                emitter.onComplete();
                emitter.onComplete();
                emitter.onNext("ğŸŠ åŠ æ€¥è¿›è´§ä¸­...");
            }
        });

        // åˆ›å»º Observer è§‚å¯Ÿè€…
        Observer<String> observer = new Observer<String>() {
            @Override
            public void onSubscribe(@NonNull Disposable d) {
                System.out.println("onSubscribe:" + d.isDisposed());
            }

            @Override
            public void onNext(@NonNull String s) {
                System.out.println("onNext:" + s);
            }

            @Override
            public void onError(@NonNull Throwable e) {
                System.out.println("onError:" + e.getMessage());
            }

            @Override
            public void onComplete() {
                System.out.println("onComplete");
            }
        };
        // å…³è”è®¢é˜…å…³ç³»
        observable.subscribe(observer);
    }

}
```

è¿è¡Œç»“æœï¼Œå¦‚ä¸‹ï¼š

```bash
onSubscribe:false
onNext:ğŸŠ åˆ°è´§äº†ï¼
onNext:å¤§å®¶å¯ä»¥æ¥ä¹° ğŸŠ äº†ï¼
onError:ğŸŠ åˆå–å®Œäº†ï¼

BUILD SUCCESSFUL in 328ms
```

é€šè¿‡ç®€å•çš„ä½¿ç”¨æ¡ˆä¾‹å’Œè¿è¡Œç»“æœï¼Œå¯çŸ¥ï¼š

- `onNext()` å¯ä»¥å¤šæ¬¡å‘é€äº‹ä»¶
- `onComplete()` å¯ä»¥å¤šæ¬¡è°ƒç”¨ä¸ä¼šæŠ¥é”™ï¼Œä½†åªæ‰§è¡Œä¸€æ¬¡
- `onError()` åªèƒ½å‘é€ä¸€æ¬¡ï¼Œå¤šæ¬¡è°ƒç”¨ä¼šæŠ¥é”™ï¼Œä¸å¯å’Œ `onComplete()` å…±å­˜
- `onComplete()` å’Œ `onError()` éƒ½å­˜åœ¨æ—¶ï¼Œåªæ‰§è¡Œ `onError()`
- `onComplete()` å’Œ `onError()` ä¹‹åï¼Œè§‚å¯Ÿè€…æ— æ³•æ¥æ”¶åˆ°å‘é€äº‹ä»¶
- `onSubscribe()` æ˜¯åœ¨è®¢é˜…ä¹‹åï¼Œå‘é€äº‹ä»¶ä¹‹å‰æ‰§è¡Œ

## RxJavaç¼–ç¨‹æ€æƒ³

**RxJava** æ˜¯åœ¨ Java ä¸Šçš„å“åº”å¼æ‰©å±•ï¼Œé€šè¿‡ä½¿ç”¨å¯è§‚å¯Ÿåºåˆ—ï¼Œç”¨äºç»„æˆå¼‚æ­¥å’ŒåŸºäºäº‹ä»¶ç¼–ç¨‹çš„ç±»åº“ï¼Œä¹Ÿå°±æ˜¯ä»¥å“åº”å¼ç¼–ç¨‹æ€ç»´æ¥è¿›è¡Œç¼–ç¨‹çš„Javaç±»åº“ã€‚

å“åº”å¼ç¼–ç¨‹æ˜¯é¢å‘æ•°æ®æµçš„ç¼–ç¨‹æ€æƒ³ï¼Œåœ¨å“åº”å¼ç¼–ç¨‹æ€æƒ³ä¸‹ï¼Œä¸€åˆ‡çš†æ•°æ®æµã€‚å“åº”å¼ç¼–ç¨‹æ‰€ä¾§é‡çš„æ˜¯æ•°æ®æµçš„æµåŠ¨ã€‚

### å“åº”å¼ç¼–ç¨‹æ¡ˆä¾‹

æˆ‘ä»¬åœ¨ç†è§£å“åº”å¼ç¼–ç¨‹ä¹‹å‰ï¼Œå…ˆæ¥ä½¿ç”¨æˆ‘ä»¬ä¼ ç»Ÿçš„æ€æƒ³å®ç°ä¸€ä¸ªåŠ è½½ç½‘ç»œå›¾ç‰‡çš„æ¡ˆä¾‹ï¼š

```java
public class MainActivity extends AppCompatActivity {

    private static final String TAG = "MainActivity";
    private ImageView imageView;
    private final static String URL = "https://cdn.lishaoy.net/serializable/serializable.png";
    private final Handler handler = new Handler(new Handler.Callback() {
        @Override
        public boolean handleMessage(@NonNull Message msg) {
            Log.i(TAG, "handleMessage: aaa");
            Bitmap bitmap = (Bitmap) msg.obj;
            imageView.setImageBitmap(bitmap);
            if (loading != null) loading.dismiss();
            return false;
        }
    });
    private ProgressDialog loading;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        imageView = findViewById(R.id.image_view);
    }

    public void loadImage(View view) {
        loading = ProgressDialog.show(this, "", "loading");
        new Thread(new Runnable() {
            @Override
            public void run() {
                try {
                    URL url = new URL(URL);
                    HttpURLConnection urlConnection = (HttpURLConnection) url.openConnection();
                    urlConnection.setConnectTimeout(6000);
                    int responseCode = urlConnection.getResponseCode();
                    if(responseCode == HttpURLConnection.HTTP_OK) {
                        InputStream inputStream = urlConnection.getInputStream();
                        Bitmap bitmap = BitmapFactory.decodeStream(inputStream);
                        Message message = handler.obtainMessage();
                        message.obj = bitmap;
                        handler.sendMessage(message);
                    }
                } catch (MalformedURLException e) {
                    e.printStackTrace();
                } catch (IOException e) {
                    e.printStackTrace();
                }
            }
        }).start();
    }
}
```

å¦‚ä¸Šï¼Œæˆ‘ä»¬å¯èƒ½ä¼šç”¨ `new Thread()` å’Œ `Handler` æ¥å®ç°æˆ–è€…å…¶ä»–æ–¹æ³•ï¼Œæ¯ä¸ªäººçš„å®ç°æ–¹æ³•å¯èƒ½éƒ½ä¸åŒã€‚å¦‚æœï¼Œä½¿ç”¨ **RxJava** æ€æƒ³å®ç°å‘¢ï¼Œå¿…ç„¶å®ç°æ–¹å¼è¦æŒ‰ç…§å“åº”å¼ç¼–ç¨‹æ•°æ®æµçš„ç¼–ç¨‹æ€æƒ³ï¼Œå®ç°æ–¹å¼ä¹Ÿå°±ä¸€è‡´äº†ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬å†ç”¨ **RxJava** æ¥å®ç°å®ƒï¼Œå¦‚ä¸‹ï¼š

```java
public class MainActivity extends AppCompatActivity {

    private static final String TAG = "MainActivity";
    private ImageView imageView;
    private final static String URL = "https://cdn.lishaoy.net/image/112131.jpg";
    private ProgressDialog loading;
    private Disposable disposable;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        imageView = findViewById(R.id.image_view);
    }

    public void rxJavaLoadImage(View view) {
        // Observable.just(URL) åˆ›å»ºè¢«è§‚å¯Ÿè€…
        Observable.just(URL)
                .map(new Function<String, Bitmap>() {
                    @Override
                    public Bitmap apply(String s) throws IOException {
                        URL url = new URL(URL);
                        HttpURLConnection urlConnection = (HttpURLConnection) url.openConnection();
                        urlConnection.setConnectTimeout(6000);
                        int responseCode = urlConnection.getResponseCode();
                        if (responseCode == HttpURLConnection.HTTP_OK) {
                            InputStream inputStream = urlConnection.getInputStream();
                            Bitmap bitmap = BitmapFactory.decodeStream(inputStream);
                            return bitmap;
                        }
                        return null;
                    }
                })
                .subscribeOn(Schedulers.io()) // ä¸Šé¢çš„ä»£ç åˆ†é…å·¥ä½œçº¿ç¨‹
                .observeOn(AndroidSchedulers.mainThread()) // ä¸‹é¢çš„ä»£ç åˆ†åˆ«UIçº¿ç¨‹
                // é“¾å¼è°ƒç”¨ subscribe ç»‘å®šè§‚å¯Ÿè€…
                .subscribe(new Observer<Bitmap>() {
                    // onSubscribe() æ–¹æ³•åœ¨å‘é€äº‹ä»¶ä¹‹å‰æ‰§è¡Œ
                    @Override
                    public void onSubscribe(Disposable d) {
                        loading = ProgressDialog.show(MainActivity.this, "", "loading");
                        disposable = d;
                    }

                    // onNext() åœ¨å‘é€äº‹ä»¶ä¹‹åæ‰§è¡Œ
                    @Override
                    public void onNext(Bitmap bitmap) {
                        imageView.setImageBitmap(bitmap);
                    }

                    @Override
                    public void onError(Throwable e) {
                        Log.e(TAG, "onError: " + e.getMessage(), e);
                    }

                    @Override
                    public void onComplete() {
                        if (loading != null) loading.dismiss();
                    }
                });
    }

    @Override
    protected void onDestroy() {
        super.onDestroy();
        disposable.dispose();
    }
}
```

è¿è¡Œç»“æœå¦‚å›¾ï¼š

<div style="width: 56%; margin:auto">

![no-shadow](https://cdn.lishaoy.net/rxjava/load_image.png "")

</div>

**RxJava** ä»¥é“¾å¼è°ƒç”¨ï¼Œ`Observable.just(URL)` åˆ†å‘äº‹ä»¶ï¼Œ`map()` æ¥åŠ å·¥æ•°æ®æµ(å¯ä»¥ä½¿ç”¨å¤šä¸ªmapå¤„ç†ä¸åŒçš„ä¸šåŠ¡)ã€`subscribeOn(Schedulers.io())` åˆ‡æ¢å·¥ä½œçº¿ç¨‹ã€`observeOn(AndroidSchedulers.mainThread())` åˆ‡æ¢ä¸»çº¿ç¨‹ï¼Œæ•°æ®æµæµå‘ `subscribe` è¿›è¡Œå¤„ç†(ä¸‹æ¸¸çš„å¤„ç†æ ¹æ®ä¸Šæ¸¸çš„æ•°æ®æµå˜åŒ–è€Œå˜åŒ–)ã€‚

## RxJavaç»“åˆRetrofitä½¿ç”¨(æ¡ˆä¾‹)

é€šè¿‡ **RxJava** ä½¿ç”¨ï¼Œç°åœ¨æˆ‘ä»¬å·²ç»äº†è§£å®ƒçš„æµå¼çš„å“åº”å¼ç¼–ç¨‹çš„æ€æƒ³ï¼Œä¸‹é¢æˆ‘ä»¬é€šè¿‡å’Œ `Retrofit` ç»“åˆä½¿ç”¨ï¼Œçœ‹çœ‹æ˜¯ä»€ä¹ˆä½“éªŒï¼Ÿ

æˆ‘ä»¬ä½¿ç”¨ [ç©Android å¼€æ”¾API](https://www.wanandroid.com/blog/show/2) æ¥å®Œæˆæœ¬æ¬¡æ¡ˆä¾‹ã€‚é¦–å…ˆæˆ‘ä»¬ä½¿ç”¨ `Retrofit` å®šä¹‰ä¸€ä¸ª `Api` çš„æ¥å£ï¼Œå¦‚ä¸‹ï¼š

```java
public interface Api {
    // è·å–é¡¹ç›®åˆ†ç±»æ•°æ®
    @GET("project/tree/json")
    Observable<ProjectBean> getProject();
    // è·å–é¡¹ç›®åˆ—è¡¨æ•°æ®(é¡¹ç›®åˆ—è¡¨æ•°æ®ä¾èµ–äºé¡¹ç›®åˆ†ç±»æ•°æ®çš„id)
    @GET("project/list/{pageIndex}/json")
    Observable<ProjectItem> getProjectItem(@Path("pageIndex") int pageIndex, @Query("cid") int cid);

}
```

`ProjectBean`ã€`ProjectItem` JavaBean æˆ‘ä»¬æ ¹æ®æ¥å£è¿”å›çš„æ•°æ®åˆ©ç”¨å·¥å…· `GsonFormat` ç”Ÿæˆã€‚

ç„¶åï¼Œæ–°å»ºä¸€ä¸ª `HttpClient` ç”Ÿæˆ `Retrofit`ï¼Œå¦‚ä¸‹ï¼š

```java
public class HttpClient {
    // api çš„ base url
    public static String BASE_URL = "https://www.wanandroid.com/";

    public static void setBaseUrl(String baseUrl) {
        BASE_URL = baseUrl;
    }

    // åˆ›å»º Retrofit
    public static Retrofit getRetrofit() {
        // åˆ›å»º OkHttp å®¢æˆ·ç«¯
        OkHttpClient.Builder builder = new OkHttpClient.Builder();
        // é…ç½®å‚æ•°
        OkHttpClient httpClient = builder.addNetworkInterceptor(new StethoInterceptor())
                .readTimeout(6666, TimeUnit.SECONDS)
                .connectTimeout(6666, TimeUnit.SECONDS)
                .writeTimeout(6666, TimeUnit.SECONDS)
                .build();

        return new Retrofit.Builder().baseUrl(BASE_URL)
                .client(httpClient) // ä½¿ç”¨ OkHttp è®¿é—®ç½‘ç»œ
                .addConverterFactory(GsonConverterFactory.create(new Gson())) // è®¾ç½® json è§£æå·¥å…·
                .addCallAdapterFactory(RxJava2CallAdapterFactory.create()) // è®¾ç½® rxjava
                .build();
    }

}
```

å†æ–°å»ºä¸€ä¸ª `RetrofitActivity` æ¥æ¼”ç¤ºï¼Œå¦‚ä¸‹ï¼š

```java
public class RetrofitActivity extends AppCompatActivity {

    private static final String TAG = "RetrofitActivity";
    private Api api;
    private TextView textView;
    private String itemData;
    private Disposable disposable;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_retrofit);
        textView = findViewById(R.id.text_view);

        api = HttpClient.getRetrofit().create(Api.class); // ç”Ÿæˆ api
    }

    // æŸ¥è¯¢é¡¹ç›®åˆ†ç±»æ•°æ®
    @SuppressLint("CheckResult")
    public void getProject(View view) {
        disposable = api.getProject() // æŸ¥è¯¢é¡¹ç›®åˆ†ç±»æ•°æ®(è¿”å›çš„æ˜¯ Observable è¢«è§‚å¯Ÿè€…)
                .subscribeOn(Schedulers.io()) // ç»™ä¸Šé¢çš„ä»£ç åˆ†é…å·¥ä½œçº¿ç¨‹
                .observeOn(AndroidSchedulers.mainThread()) // ç»™ä¸‹é¢çš„ä»£ç åˆ†é…ä¸»çº¿ç¨‹
                .subscribe(new Consumer<ProjectBean>() { // è®¢é˜…å¹¶åˆ›å»ºè§‚å¯Ÿè€…
                    @Override
                    public void accept(ProjectBean projectBean) throws Exception {
                        textView.setText(projectBean.toString()); // è¿›è¡Œ UI æ“ä½œ
                    }
                });
    }

    @Override
    protected void onDestroy() {
        super.onDestroy();
        disposable.dispose();
    }

}
```

è¿è¡Œç»“æœå¦‚å›¾ï¼š

<div style="width: 56%; margin:auto">

![no-shadow](https://cdn.lishaoy.net/rxjava/get_project.png "")

</div>

å¯è§ `Retrofit` å’Œ `RxJava` ç»“åˆä½¿ç”¨ï¼Œä»£ç é‡å‡å°‘çš„åŒæ—¶ï¼Œæ•´ä¸ªæµç¨‹æ€è·¯æ›´ä¸ºæ¸…æ™°ï¼Œä¸”å¯ä»¥ä¸ºæ‰€æ¬²ä¸ºçš„åˆ‡æ¢çº¿ç¨‹ã€‚

### é˜²æŠ–

æˆ‘ä»¬å†ä½¿ç”¨é˜²æŠ–(é˜²æ­¢ç”¨æˆ·æ“ä½œå¸¦æ¥çš„é¢‘ç¹å‘èµ·è¯·æ±‚é—®é¢˜)çš„æ–¹å¼æ¥æŸ¥è¯¢é¡¹ç›®åˆ—è¡¨æ•°æ®ï¼Œå¦‚ä¸‹ï¼š

```java
public class RetrofitActivity extends AppCompatActivity {

    private static final String TAG = "RetrofitActivity";
    private Api api;
    private TextView textView;
    private String itemData;
    private Disposable disposable;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_retrofit);
        textView = findViewById(R.id.text_view);

        api = HttpClient.getRetrofit().create(Api.class); // ç”Ÿæˆ api
        getProjectItemData();
    }

    ...

    // æŸ¥è¯¢é¡¹ç›®åˆ—è¡¨æ•°æ®ï¼Œé¡¹ç›®åˆ—è¡¨æ•°æ®éœ€è¦æ ¹æ®é¡¹ç›®åˆ†ç±»æ•°æ®çš„ id è¿›è¡ŒæŸ¥è¯¢
    // ä¸”ä½¿ç”¨ rxbinding å¢åŠ é˜²æŠ–åŠŸèƒ½
    public void getProjectItemData() {
        Button button = findViewById(R.id.get_item_button_fd);
        disposable = RxView.clicks(button) // è®¾ç½®é˜²æŠ–çš„ view
                .throttleFirst(2600, TimeUnit.MILLISECONDS) // è®¾ç½®åœ¨ 2.6 ç§’å†…åªå“åº”ä¸€æ¬¡ç‚¹å‡»äº‹ä»¶
                .subscribe(new Consumer<Object>() {
                    @Override
                    public void accept(Object o) throws Exception {
                        disposable = api.getProject() // æŸ¥è¯¢é¡¹ç›®åˆ†ç±»æ•°æ®(è¿”å›çš„æ˜¯ Observable è¢«è§‚å¯Ÿè€…)
                                .subscribeOn(Schedulers.io()) // ç»™ä¸Šé¢çš„ä»£ç åˆ†é…å·¥ä½œçº¿ç¨‹
                                .observeOn(AndroidSchedulers.mainThread()) // ç»™ä¸‹é¢çš„ä»£ç åˆ†é…ä¸»çº¿ç¨‹
                                .subscribe(new Consumer<ProjectBean>() { // è®¢é˜…å¹¶åˆ›å»ºè§‚å¯Ÿè€…
                                    @Override
                                    public void accept(final ProjectBean projectBean) throws Exception {
                                        for (ProjectBean.DataBean bean: projectBean.getData()) {
                                            disposable = api.getProjectItem(1, bean.getId()) // æ ¹æ®é¡¹ç›®åˆ†ç±»æ•°æ®çš„ id æŸ¥è¯¢é¡¹ç›®åˆ—è¡¨æ•°æ®(è¿”å›çš„æ˜¯ Observable è¢«è§‚å¯Ÿè€…)
                                                    .subscribeOn(Schedulers.io()) // ç»™ä¸Šé¢çš„ä»£ç åˆ†é…å·¥ä½œçº¿ç¨‹
                                                    .observeOn(AndroidSchedulers.mainThread()) // ç»™ä¸‹é¢çš„ä»£ç åˆ†é…ä¸»çº¿ç¨‹
                                                    .subscribe(new Consumer<ProjectItem>() { // è®¢é˜…å¹¶åˆ›å»ºè§‚å¯Ÿè€…
                                                        @Override
                                                        public void accept(ProjectItem projectItem) throws Exception {
                                                            Log.d(TAG, "accept: " + projectItem);
                                                            textView.setText(projectItem.toString()); // è¿›è¡Œ UI æ“ä½œ
                                                        }
                                                    });
                                        }
                                    }
                                });
                    }
                });
    }

    @Override
    protected void onDestroy() {
        super.onDestroy();
        disposable.dispose();
    }

}
```

è¿è¡Œç»“æœå¦‚å›¾ï¼š

<div style="width: 56%; margin:auto">

![no-shadow](https://cdn.lishaoy.net/rxjava/get_item.png "")

</div>

å¯è§ä»¥ä¸Šä»£ç è™½ç„¶å®ç°äº†é˜²æŠ–å’ŒåµŒå¥—æŸ¥è¯¢çš„åŠŸèƒ½ï¼Œä½†æ˜¯ï¼Œä»£ç åµŒå¥—è¿‡å¤šï¼Œéš¾ä»¥ç»´æŠ¤ã€‚

### è§£å†³ç½‘ç»œåµŒå¥—é—®é¢˜

ä¸Šé¢çš„ä»£ç è™½æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯åµŒå¥—å¤ªå¤šï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨ `flatMap` æ“ä½œç¬¦æ¥è§£å†³æ­¤é—®é¢˜ï¼Œå¦‚ä¸‹ï¼š

```java
public class RetrofitActivity extends AppCompatActivity {

    private static final String TAG = "RetrofitActivity";
    private Api api;
    private TextView textView;
    private String itemData;
    private Disposable disposable;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_retrofit);
        textView = findViewById(R.id.text_view);

        api = HttpClient.getRetrofit().create(Api.class); // ç”Ÿæˆ api
        getProjectItemData();
        getItemData();
    }

    ...

    // æŸ¥è¯¢é¡¹ç›®åˆ—è¡¨æ•°æ®ï¼Œä½¿ç”¨ flatMap æ“ä½œç¬¦ï¼Œè§£å†³ç½‘ç»œåµŒå¥—é—®é¢˜
    public void getItemData(){
        Button button = findViewById(R.id.get_item_button);
       disposable = RxView.clicks(button) // è®¾ç½®é˜²æŠ–çš„ view
                .throttleFirst(2600, TimeUnit.MILLISECONDS) // è®¾ç½®åœ¨ 2.6 ç§’å†…åªå“åº”ä¸€æ¬¡ç‚¹å‡»äº‹ä»¶
                .observeOn(Schedulers.io()) // ç»™ä¸‹é¢çš„ä»£ç åˆ†é…å·¥ä½œçº¿ç¨‹
                .flatMap(new Function<Object, ObservableSource<ProjectBean>>() {
                    @Override
                    public ObservableSource<ProjectBean> apply(Object o) throws Exception {
                        return api.getProject(); // æŸ¥è¯¢é¡¹ç›®åˆ†ç±»æ•°æ®ï¼Œå¹¶ä¸”æŠŠæ•°æ®æµå‘ä¸‹æ¸¸
                    }
                })
                .flatMap(new Function<ProjectBean, ObservableSource<ProjectBean.DataBean>>() {
                    @Override
                    public ObservableSource<ProjectBean.DataBean> apply(ProjectBean projectBean) throws Exception {
                        return Observable.fromIterable(projectBean.getData()); // æ ¹æ®ä¸Šæ¸¸æµè¿‡æ¥çš„æ•°æ®ï¼Œè¿­ä»£å‡ºæ¯ä¸ª ProjectItem é¡¹ç›®åˆ—è¡¨æ•°æ®ï¼Œå¹¶ä¸”æµå‘ä¸‹æ¸¸
                    }
                })
                .flatMap(new Function<ProjectBean.DataBean, ObservableSource<ProjectItem>>() {
                    @Override
                    public ObservableSource<ProjectItem> apply(ProjectBean.DataBean dataBean) throws Exception {
                        return api.getProjectItem(1, dataBean.getId()); // æ ¹æ®ä¸Šæ¸¸æµè¿‡æ¥çš„æ•°æ®ï¼ŒæŸ¥è¯¢æ¯ä¸ªåˆ—è¡¨æ•°æ®ï¼Œå¹¶ä¸”æµå‘ä¸‹æ¸¸
                    }
                })
                .observeOn(AndroidSchedulers.mainThread())
                .subscribe(new Consumer<ProjectItem>() {
                    @Override
                    public void accept(ProjectItem projectItem) throws Exception {
                        itemData += projectItem.toString() + "\n ================================================ \n";
                        textView.setText(itemData); // æ ¹æ®ä¸Šæ¸¸æµè¿‡æ¥çš„æ•°æ®ï¼Œè¿›è¡Œ UI æ“ä½œ
                    }
                });
    }

    @Override
    protected void onDestroy() {
        super.onDestroy();
        disposable.dispose();
    }
}
```

è¿è¡Œç»“æœå¦‚å›¾ï¼š

<div style="width: 56%; margin:auto">

![no-shadow](https://cdn.lishaoy.net/rxjava/get_item1.png "")

</div>

å¯è§ï¼Œä½¿ç”¨ `flatMap` æ“ä½œç¬¦åï¼Œæ€è·¯æ›´ä¸ºæ¸…æ™°ï¼Œä»£ç å¹³é“ºä¸‹æ¥æ›´æ˜“ç†è§£ï¼Œä»¥ä¸€ç§æµå¼çš„æ–¹å¼ä¸æ–­çš„å‘ä¸‹æ¸¸æµå»æ•°æ®ï¼Œä¸‹æ¸¸æ ¹æ®ä¸Šæ¸¸çš„æ•°æ®å¯ä»¥å†³å®šæ˜¯å¦ç»§ç»­å‘ä¸‹æ¸¸æµæˆ–è€…åšUIæ›´æ–°æ“ä½œç­‰ï¼Œ`flatMap` æ“ä½œç¬¦å¯ä»¥é‡å¤ä½¿ç”¨ï¼Œä¸”çº¿ç¨‹çš„åˆ‡æ¢å¯ä»¥éšæ„åˆ‡æ¢ï¼Œè¿™ä¸ªå°±æ˜¯ `RxJava` æ•°æ®æµå¼çš„å“åº”å¼ç¼–ç¨‹æ€æƒ³ã€‚

## Hooké’©å­å‡½æ•°

æˆ‘ä»¬å·²ç»äº†è§£äº† `RxJava` çš„æ€æƒ³å’Œä½¿ç”¨ï¼Œç°åœ¨æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒçš„æºç ï¼Œæˆ‘ä»¬ä»åˆ›å»ºä¸€ä¸ªè¢«è§‚å¯Ÿè€…(Observable)å¼€å§‹ `Observable.create`ï¼Œç‚¹å‡» `create`ï¼Œå¦‚ä¸‹ï¼š

```java
public static <T> Observable<T> create(@NonNull ObservableOnSubscribe<T> source) {
    Objects.requireNonNull(source, "source is null");
    return RxJavaPlugins.onAssembly(new ObservableCreate<>(source));
}
```

å¾ˆç®€å•ï¼Œå°±è¿™ä¹ˆä¸€å¥ `RxJavaPlugins.onAssembly()` ä»£ç ï¼Œæˆ‘ä»¬ç‚¹è¿› `onAssembly` å¦‚ä¸‹ï¼š

```java
/**
  * Calls the associated hook function.
  * @param <T> the value type
  * @param source the hook's input value
  * @return the value returned by the hook
  */
@SuppressWarnings({ "rawtypes", "unchecked" })
@NonNull
public static <T> Observable<T> onAssembly(@NonNull Observable<T> source) {
    Function<? super Observable, ? extends Observable> f = onObservableAssembly;
    if (f != null) {
        return apply(f, source);
    }
    return source;
}
```

å¯ä»¥çœ‹åˆ°æ³¨é‡Šï¼šCalls the associated hook function(è°ƒç”¨å…³è”çš„é’©å­å‡½æ•°)ï¼ŒæŠŠ `onObservableAssembly` èµ‹å€¼ç»™äº† `f` å‡½æ•°ï¼Œæˆ‘ä»¬é€šè¿‡æŸ¥æ‰¾ `onObservableAssembly` å‘ç°ä»–å¹¶æ²¡æœ‰èµ‹å€¼ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒå§‹ç»ˆæ˜¯ `null`ï¼Œæ‰€ä»¥ï¼Œåœ¨æ²¡æœ‰ç»™ `onObservableAssembly` èµ‹å€¼çš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªå‡½æ•°ä»€ä¹ˆä¹Ÿä¸ä¼šåšï¼›æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦ç»™ `onObservableAssembly` å‡½æ•°èµ‹å€¼å°±å¯ä»¥å…ˆ `if` è¯­å¥æ‰§è¡Œ `onObservableAssembly` å‡½æ•°ï¼Œé‚£ä¹ˆæ€ä¹ˆèµ‹å€¼å‘¢ï¼Ÿæˆ‘ä»¬å¯¹ `onObservableAssembly` è¿›è¡Œæœç´¢å‘ç°ï¼Œå¦‚ä¸‹ï¼š

```java
@SuppressWarnings("rawtypes")
@Nullable
static volatile Function<? super Observable, ? extends Observable> onObservableAssembly;

RxJavaPlugins.onObservableAssembly = onObservableAssembly;
```

`onObservableAssembly` æ˜¯ `RxJavaPlugins` ç±»çš„ä¸€ä¸ªé™æ€å˜é‡ï¼Œäºæ˜¯æˆ‘ä»¬å°±çŸ¥é“å¦‚ä½•èµ‹å€¼äº†ï¼Œæˆ‘ä»¬ç”¨ä¹‹å‰ä¾‹å­æ¥æµ‹è¯•ï¼Œå¦‚ä¸‹ï¼š

```java
public class UseRxJava {

    public static void main(String[] args) {
        // ç»™ hook é’©å­å‡½æ•°èµ‹å€¼
        RxJavaPlugins.setOnObservableAssembly(new Function<Observable, Observable>() {
            @Override
            public Observable apply(Observable observable) throws Throwable {
                System.out.println(observable + " ä½ æƒ³ä¹°ğŸŠ ï¼Ÿ");
                return observable;
            }
        });
        // æ–°å¢ä¸€ä¸ªæµ‹è¯•è¢«è§‚å¯Ÿè€…
        Observable.just("ğŸŠ")
                .map(new Function<String, Object>() {
                    @Override
                    public Object apply(String s) throws Throwable {
                        return "lsy ä¹°äº† " + s;
                    }
                })
                .subscribe(new Consumer<Object>() {
                    @Override
                    public void accept(Object o) throws Throwable {
                        System.out.println(o);
                    }
                });
        // åˆ›å»º Observable è¢«è§‚å¯Ÿè€…
        Observable observable = Observable.create(new ObservableOnSubscribe<String>() {
            @Override
            public void subscribe(@NonNull ObservableEmitter<String> emitter) throws Throwable {
                emitter.onNext("ğŸŠ åˆ°è´§äº†ï¼");
                emitter.onNext("å¤§å®¶å¯ä»¥æ¥ä¹° ğŸŠ äº†ï¼");
                emitter.onError(new Throwable("ğŸŠ åˆå–å®Œäº†ï¼"));
                emitter.onNext("WOWï¼ğŸŠ å–å…‰äº†");
                emitter.onComplete();
                emitter.onComplete();
                emitter.onNext("ğŸŠ åŠ æ€¥è¿›è´§ä¸­...");
            }
        });

        // åˆ›å»º Observer è§‚å¯Ÿè€…
        Observer<String> observer = new Observer<String>() {
            @Override
            public void onSubscribe(@NonNull Disposable d) {
                System.out.println("onSubscribe:" + d.isDisposed());
            }

            @Override
            public void onNext(@NonNull String s) {
                System.out.println("onNext:" + s);
            }

            @Override
            public void onError(@NonNull Throwable e) {
                System.out.println("onError:" + e.getMessage());
            }

            @Override
            public void onComplete() {
                System.out.println("onComplete");
            }
        };
        // å…³è”è®¢é˜…å…³ç³»
        observable.subscribe(observer);
    }

}
```

è¿è¡Œç»“æœï¼Œå¦‚ä¸‹ï¼š

```bash
io.reactivex.rxjava3.internal.operators.observable.ObservableJust@694f9431 ä½ æƒ³ä¹°ğŸŠ ï¼Ÿ
io.reactivex.rxjava3.internal.operators.observable.ObservableMap@f2a0b8e ä½ æƒ³ä¹°ğŸŠ ï¼Ÿ
lsy ä¹°äº† ğŸŠ
io.reactivex.rxjava3.internal.operators.observable.ObservableCreate@515f550a ä½ æƒ³ä¹°ğŸŠ ï¼Ÿ
onSubscribe:false
onNext:ğŸŠ åˆ°è´§äº†ï¼
onNext:å¤§å®¶å¯ä»¥æ¥ä¹° ğŸŠ äº†ï¼
onError:ğŸŠ åˆå–å®Œäº†ï¼

BUILD SUCCESSFUL in 868ms
```

æˆ‘ä»¬ `hook` é’©å­å‡½æ•°æ‰§è¡Œäº†3æ¬¡ï¼Œåˆ†åˆ«æ˜¯ï¼š`ObservableJust`ã€`ObservableMap`ã€`ObservableCreate`ï¼Œå¯çŸ¥ï¼Œ`hook` é’©å­å‡½æ•°æ˜¯ä¸€ä¸ªå…¨å±€ç›‘å¬å‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ©ç”¨å®ƒåšå¾ˆå¤šäº‹æƒ…ã€‚

## RxJavaè§‚å¯Ÿè€…æ¨¡å¼å’Œæ ‡å‡†è§‚å¯Ÿè€…æ¨¡å¼

æˆ‘ä»¬æ¥ç»§ç»­è§£è¯»æºç ï¼Œé€šè¿‡æ ‡å‡†è§‚å¯Ÿè€…æ¨¡å¼å’Œ `RxJava` è§‚å¯Ÿè€…æ¨¡å¼çš„æ¯”è¾ƒå·²åŒºåˆ«æ¥æ›´åŠ æ·±åˆ»çš„ç†è§£ `RxJava`ã€‚

ä¸Šé¢æˆ‘ä»¬é€šè¿‡æºç äº†è§£åˆ° `hook` é’©å­å‡½æ•°ï¼Œ`Observable.create` åˆ›å»ºä¸€ä¸ªè¢«è§‚å¯Ÿè€…æ—¶å¦‚æœæˆ‘ä»¬ç»™é’©å­å‡½æ•°èµ‹å€¼ï¼Œå°±ä¼šå…ˆæ‰§è¡Œé’©å­å‡½æ•°ï¼›é‚£ä¹ˆï¼Œæˆ‘ä»¬çš„å‡†è§‚å¯Ÿè€…æ¨¡å¼å’Œ **RxJava** è§‚å¯Ÿè€…æ¨¡å¼æœ‰ä»€ä¹ˆä¸åŒå‘¢ï¼Ÿ

æ ‡å‡†è§‚å¯Ÿè€…æ¨¡å¼æœ‰4ä¸ªè§’è‰²ï¼šObservable(è¢«è§‚å¯Ÿè€…)ã€ConcreteObservable(å…·ä½“çš„è¢«è§‚å¯Ÿè€…)ã€Observer(è§‚å¯Ÿè€…)ã€ConcreteObserver(å…·ä½“çš„è§‚å¯Ÿè€…)ï¼Œ**RxJava** è§‚å¯Ÿè€…æ¨¡å¼çš„è¿™4ä¸ªè§’è‰²åˆ†åˆ«æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå¯¹åº”å…³ç³»å¦‚ä¸‹ï¼š

|   æ ‡å‡†è§‚å¯Ÿè€…æ¨¡å¼      |  RxJavaè§‚å¯Ÿè€…æ¨¡å¼   |
|: ----------------- :|: --------------- :|
| Observable (è¢«è§‚å¯Ÿè€…) |    Observable æ¥å£   |
| ConcreteObservable(å…·ä½“çš„è¢«è§‚å¯Ÿè€…) | Observable.create(ï¼‰åˆ›å»ºå‡ºæ¥çš„ï¼Œæœ€ç»ˆæ˜¯ä¸€ä¸ª ObservableCreate å¯¹è±¡ |
| Observer(è§‚å¯Ÿè€…)    | Observer æ¥å£        |
| ConcreteObserver(å…·ä½“çš„è§‚å¯Ÿè€…) | new Observer<String>() { } åˆ›å»ºå‡ºæ¥çš„è§‚å¯Ÿè€…å¯¹è±¡ |

åœ¨æ ‡å‡†çš„è§‚å¯Ÿè€…æ¨¡å¼ä¸­ Observable (è¢«è§‚å¯Ÿè€…) æ˜¯æŒæœ‰ Observer(è§‚å¯Ÿè€…) åˆ—è¡¨çš„ï¼Œé‚£ä¹ˆ **RxJava** è§‚å¯Ÿè€…æ¨¡å¼å‘¢ï¼Ÿ

æˆ‘ä»¬æ¥ç»§ç»­çœ‹æºç ï¼Œä¸Šæ–‡æˆ‘ä»¬å·²ç»çœ‹è¿‡ `Observable.create`ï¼Œç‚¹å‡» `create`ï¼Œå¦‚ä¸‹ï¼š

```java
public static <T> Observable<T> create(@NonNull ObservableOnSubscribe<T> source) {
    Objects.requireNonNull(source, "source is null");
    return RxJavaPlugins.onAssembly(new ObservableCreate<>(source));
}
```

`RxJavaPlugins.onAssembly()` æˆ‘ä»¬å·²ç»çœ‹è¿‡ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ `new ObservableCreate<>(source)`ï¼Œ è¿™ä¸ª `source` å°±æ˜¯æˆ‘ä»¬ä¼ è¿›æ¥çš„ `new ObservableOnSubscribe(){ ... }`ï¼Œæˆ‘ä»¬ç‚¹è¿› `ObservableCreate` å¦‚ä¸‹ï¼š

```java
public final class ObservableCreate<T> extends Observable<T> {
    final ObservableOnSubscribe<T> source;

    public ObservableCreate(ObservableOnSubscribe<T> source) {
        this.source = source;
    }

    ...

}
```

å¯çŸ¥ï¼Œ`return RxJavaPlugins.onAssembly(new ObservableCreate<>(source));` è¿”å›çš„æ˜¯ `ObservableCreate(ObservableOnSubscribe<T> source) { this.source = source; }`ï¼Œè€Œ `source` æ˜¯æˆ‘ä»¬è‡ªå·±ä¼ è¿›å»çš„ï¼›

æˆ‘ä»¬å†æ¥çœ‹çœ‹è®¢é˜… `observable.subscribe(observer)` ä»£ç ï¼Œç‚¹è¿› `subscribe`ï¼Œå¦‚ä¸‹ï¼š

```java
@SchedulerSupport(SchedulerSupport.NONE)
@Override
public final void subscribe(@NonNull Observer<? super T> observer) {
    Objects.requireNonNull(observer, "observer is null");
    try {
        observer = RxJavaPlugins.onSubscribe(this, observer);

        Objects.requireNonNull(observer, "The RxJavaPlugins.onSubscribe hook returned a null Observer. Please change the handler provided to RxJavaPlugins.setOnObservableSubscribe for invalid null returns. Further reading: https://github.com/ReactiveX/RxJava/wiki/Plugins");

        subscribeActual(observer);
    } catch (NullPointerException e) { // NOPMD
        throw e;
    } catch (Throwable e) {
        Exceptions.throwIfFatal(e);
        // can't call onError because no way to know if a Disposable has been set or not
        // can't call onSubscribe because the call might have set a Subscription already
        RxJavaPlugins.onError(e);

        NullPointerException npe = new NullPointerException("Actually not, but can't throw other exceptions due to RS");
        npe.initCause(e);
        throw npe;
    }
}
```

æˆ‘ä»¬çœ‹åˆ°é‡ç‚¹ä»£ç  `subscribeActual(observer);` ç‚¹è¿› `subscribeActual` å¦‚ä¸‹ï¼š

```java
protected abstract void subscribeActual(@NonNull Observer<? super T> observer);
```

æ˜¯ä¸€ä¸ªæŠ½è±¡å‡½æ•°ï¼Œä¹Ÿå°±è¯´å®ƒçš„å®ç°æ˜¯åœ¨ `ObservableCreate` ç±»é‡Œé¢çš„ï¼Œå› ä¸ºï¼Œæ˜¯ `ObservableCreate` è°ƒç”¨äº† `subscribe` æ–¹æ³•ï¼Œé‚£ä¹ˆï¼Œæˆ‘ä»¬å°±å›åˆ° `subscribeActual` ç±»ï¼Œå¦‚ä¸‹ï¼š

```java
public final class ObservableCreate<T> extends Observable<T> {
    final ObservableOnSubscribe<T> source;

    public ObservableCreate(ObservableOnSubscribe<T> source) {
        this.source = source;
    }

    // subscribeActual æŠ½è±¡æ–¹æ³•çš„å®ç°
    @Override
    protected void subscribeActual(Observer<? super T> observer) {
        // åˆ›å»ºäº†ä¸€ä¸ª CreateEmitter å‘å°„å™¨ï¼Œä¸”ä¼ å…¥äº†ç›®æ ‡è§‚å¯Ÿè€…
        CreateEmitter<T> parent = new CreateEmitter<>(observer);
        // æ‰§è¡Œäº†ç›®æ ‡è§‚å¯Ÿè€…çš„ onSubscribe æ–¹æ³•
        observer.onSubscribe(parent);

        try {
            // æ‰§è¡Œç›®æ ‡è¢«è§‚å¯Ÿè€…(ObservableCreate) çš„ subscribe æ–¹æ³•ä¸”ä¼ å…¥äº† å‘å°„å™¨ CreateEmitter
            source.subscribe(parent);
        } catch (Throwable ex) {
            Exceptions.throwIfFatal(ex);
            parent.onError(ex);
        }
    }

}
```

å¯çŸ¥ï¼Œ`subscribeActual` æŠ½è±¡æ–¹æ³•çš„å®ç°ï¼šåˆ›å»ºäº†ä¸€ä¸ª `CreateEmitter` å‘å°„å™¨ï¼Œä¸”ä¼ å…¥äº†ç›®æ ‡è§‚å¯Ÿè€…ï¼Œä¸”æ‰§è¡Œäº†ç›®æ ‡è§‚å¯Ÿè€…çš„ `onSubscribe()` æ–¹æ³•ï¼›è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ `onSubscribe()` æ–¹æ³•ä¼šåœ¨è®¢é˜…ä¹‹åï¼Œå‘é€äº‹ä»¶ä¹‹å‰æ‰§è¡Œçš„åŸå› ã€‚

ä¹‹åï¼Œåˆæ‰§è¡Œç›®æ ‡è¢«è§‚å¯Ÿè€…(ObservableCreate) çš„ `subscribe` æ–¹æ³•ä¸”ä¼ å…¥äº†å‘å°„å™¨ `CreateEmitter`ï¼Œåœ¨çœ‹ä¸‹æˆ‘ä»¬çš„ `CreateEmitter` å‘å°„å™¨æºç ï¼Œå¦‚ä¸‹ï¼š

```java
static final class CreateEmitter<T>
    extends AtomicReference<Disposable>
    implements ObservableEmitter<T>, Disposable {

        private static final long serialVersionUID = -3434801548987643227L;

        final Observer<? super T> observer;
        // æŒæœ‰ç›®æ ‡è§‚å¯Ÿè€… observer
        CreateEmitter(Observer<? super T> observer) {
            this.observer = observer;
        }

        // æ‰§è¡Œ onNext() ä¼šè°ƒç”¨ observer.onNext(t) æ‰§è¡Œç›®æ ‡è§‚å¯Ÿè€…çš„ onNext()
        @Override
        public void onNext(T t) {
            if (t == null) {
                onError(ExceptionHelper.createNullPointerException("onNext called with a null value."));
                return;
            }
            if (!isDisposed()) {
                observer.onNext(t);
            }
        }

        @Override
        public void onError(Throwable t) {
            if (!tryOnError(t)) {
                RxJavaPlugins.onError(t);
            }
        }

       ...
```

`CreateEmitter` å‘å°„å™¨æŒæœ‰ç›®æ ‡è§‚å¯Ÿè€… `observer` ç›®æ ‡è§‚å¯Ÿè€…ï¼Œæ‰§è¡Œ `onNext()` ä¼šè°ƒç”¨ `observer.onNext(t)` æ‰§è¡Œç›®æ ‡è§‚å¯Ÿè€…çš„ `onNext()`ã€‚

**RxJava** çš„è§‚å¯Ÿè€…æ¨¡å¼æ•´ä¸ªæµç¨‹ï¼Œå¦‚å›¾ï¼š

<div style="width: 100%; margin:auto">

![no-shadow](https://cdn.lishaoy.net/rxjava/observer_uml.png "")

</div>

å¯è§ï¼Œ**RxJava** è§‚å¯Ÿè€…æ¨¡å¼å’Œæ ‡å‡†çš„è§‚å¯Ÿè€…æ¨¡å¼å®Œå…¨ä¸åŒï¼Œ**RxJava** è§‚å¯Ÿè€…æ¨¡å¼çš„è¢«è§‚å¯Ÿè€…å¹¶æ²¡æœ‰æŒæœ‰è§‚å¯Ÿè€…çš„åˆ—è¡¨ï¼Œè€Œæ˜¯é€šè¿‡ä¸€ä¸ªä¸­é—´å±‚ `CreateEmitter` å‘å°„å™¨æ¥å®Œæˆäº‹ä»¶çš„ä¼ é€’ï¼Œå®ƒæ›´åƒæ˜¯ä¸€ä¸ªå‘å¸ƒè®¢é˜…è€…æ¨¡å¼ï¼Œå¦‚å›¾ï¼š

<div style="width: 100%; margin:auto">

![no-shadow](https://cdn.lishaoy.net/rxjava/observable.png "")

</div>

## Mapæ“ä½œç¬¦åŸç†

ä¸Šæ–‡åŠ è½½å›¾ç‰‡çš„æ¡ˆä¾‹é‡Œæˆ‘ä»¬å·²ç»ä½¿ç”¨è¿‡ `map` æ“ä½œç¬¦ï¼Œç”¨æ¥æŠŠ `String` æ•°æ®åŠ å·¥æˆ `Bitmap` æ•°æ®ï¼Œä»è€Œæµå‘ä¸‹æ¸¸ï¼Œæˆ‘ä»¬æ¥å›é¡¾ä¸€ä¸‹ä¸Šæ–‡çš„æ¡ˆä¾‹ä»£ç ï¼Œå¦‚ä¸‹ï¼š

```java
public void rxJavaLoadImage(View view) {
        // Observable.just(URL) åˆ›å»ºè¢«è§‚å¯Ÿè€…
        Observable.just(URL)
                // ä½¿ç”¨ map æ“ä½œç¬¦åŠ å·¥æ•°æ®,ä» String è½¬æ¢ä¸º Bitmap
                .map(new Function<String, Bitmap>() {
                    @Override
                    public Bitmap apply(String s) throws IOException {
                        URL url = new URL(URL);
                        HttpURLConnection urlConnection = (HttpURLConnection) url.openConnection();
                        urlConnection.setConnectTimeout(6000);
                        int responseCode = urlConnection.getResponseCode();
                        if (responseCode == HttpURLConnection.HTTP_OK) {
                            InputStream inputStream = urlConnection.getInputStream();
                            Bitmap bitmap = BitmapFactory.decodeStream(inputStream);
                            return bitmap; // å°† Bitmap æ•°æ®æµå‘ä¸‹æ¸¸
                        }
                        return null;
                    }
                })
               .subscribeOn(Schedulers.io()) // ä¸Šé¢çš„ä»£ç åˆ†é…å·¥ä½œçº¿ç¨‹
               .observeOn(AndroidSchedulers.mainThread()) // ä¸‹é¢çš„ä»£ç åˆ†åˆ«UIçº¿ç¨‹
                // é“¾å¼è°ƒç”¨ subscribe ç»‘å®šè§‚å¯Ÿè€…
                .subscribe(new Observer<Bitmap>() {
                    // onSubscribe() æ–¹æ³•åœ¨å‘é€äº‹ä»¶ä¹‹å‰æ‰§è¡Œ
                    @Override
                    public void onSubscribe(Disposable d) {
                        loading = ProgressDialog.show(MainActivity.this, "", "loading");
                        disposable = d;
                    }

                    // onNext() åœ¨å‘é€äº‹ä»¶ä¹‹åæ‰§è¡Œ
                    @Override
                    public void onNext(Bitmap bitmap) {
                        imageView.setImageBitmap(bitmap);
                    }

                    @Override
                    public void onError(Throwable e) {
                        Log.e(TAG, "onError: " + e.getMessage(), e);
                    }

                    @Override
                    public void onComplete() {
                        if (loading != null) loading.dismiss();
                    }
                });
    }
```

æˆ‘ä»¬ç‚¹è¿› `map` æŸ¥çœ‹æºç ï¼Œå¦‚ä¸‹

```java
@CheckReturnValue
@SchedulerSupport(SchedulerSupport.NONE)
public final <R> Observable<R> map(Function<? super T, ? extends R> mapper) {
    ObjectHelper.requireNonNull(mapper, "mapper is null");
    return RxJavaPlugins.onAssembly(new ObservableMap<T, R>(this, mapper));
}
```

å¯çŸ¥ï¼Œæœ€ç»ˆè¿”å›çš„æ˜¯ä¸€ä¸ª `ObservableMap`ï¼Œç‚¹è¿› `ObservableMap` å¦‚ä¸‹ï¼š

```java
public final class ObservableMap<T, U> extends AbstractObservableWithUpstream<T, U> {
    final Function<? super T, ? extends U> function;

    public ObservableMap(ObservableSource<T> source, Function<? super T, ? extends U> function) {
        super(source);
        this.function = function;
    }

    // new MapObserver<T, U>(t, function) æŠŠæˆ‘ä»¬ä¼ è¿›æ¥çš„å‡½æ•°åŒ…ä¸Šäº†ä¸€æ¬¡ MapObserver
    @Override
    public void subscribeActual(Observer<? super U> t) {
        source.subscribe(new MapObserver<T, U>(t, function));
    }

    ...

}
```

å…³é”®ä»£ç  `source.subscribe(new MapObserver<T, U>(t, function))` æŠŠæˆ‘ä»¬ä¼ è¿›æ¥çš„å‡½æ•°åŒ…ä¸Šäº†ä¸€æ¬¡ `MapObserver`ï¼Œ`source.subscribe()` è¿™ä¸ª `source` å°±æ˜¯ `Observable`ï¼Œå°±ç›¸å½“äº `Observable.subscribe()`ï¼Œè€Œ `MapObserver` ç»§æ‰¿ä¸ `BasicFuseableObserver`ï¼Œ`BasicFuseableObserver` å®ç°äº† `Observer`ï¼Œæœ€ç»ˆ `source.subscribe()` ä¼šæ‰§è¡Œåˆ°ï¼š

```java
 @SchedulerSupport(SchedulerSupport.NONE)
    @Override
    public final void subscribe(@NonNull Observer<? super T> observer) {
        Objects.requireNonNull(observer, "observer is null");
        try {
            observer = RxJavaPlugins.onSubscribe(this, observer);

            Objects.requireNonNull(observer, "The RxJavaPlugins.onSubscribe hook returned a null Observer. Please change the handler provided to RxJavaPlugins.setOnObservableSubscribe for invalid null returns. Further reading: https://github.com/ReactiveX/RxJava/wiki/Plugins");
            // æ˜¯ä¸€ä¸ªé™æ€æŠ½è±¡æ–¹æ³•ï¼Œæœ€ç»ˆç”±å®ç°ç±»å®Œæˆ
            subscribeActual(observer);
        } catch (NullPointerException e) { // NOPMD
            throw e;
        } catch (Throwable e) {
            Exceptions.throwIfFatal(e);
            // can't call onError because no way to know if a Disposable has been set or not
            // can't call onSubscribe because the call might have set a Subscription already
            RxJavaPlugins.onError(e);

            NullPointerException npe = new NullPointerException("Actually not, but can't throw other exceptions due to RS");
            npe.initCause(e);
            throw npe;
        }
    }
```

`subscribeActual(observer)` æ˜¯ä¸€ä¸ªé™æ€æŠ½è±¡æ–¹æ³•ï¼Œæœ€ç»ˆç”±å®ç°ç±»å®Œæˆï¼Œä¹Ÿå°±æ˜¯ `ObservableJust` çš„ `subscribeActual` æ–¹æ³•ï¼Œå¦‚ä¸‹

```java
public final class ObservableJust<T> extends Observable<T> implements ScalarSupplier<T> {

    private final T value;
    public ObservableJust(final T value) {
        this.value = value;
    }
    // source.subscribe(new MapObserver<T, U>(t, function)); åˆå¯¹ observer åŒ…è£¹äº†ä¸€å±‚
    @Override
    protected void subscribeActual(Observer<? super T> observer) {
        ScalarDisposable<T> sd = new ScalarDisposable<>(observer, value);
        observer.onSubscribe(sd);
        sd.run();
    }

    @Override
    public T get() {
        return value;
    }
}
```

`observer` æ˜¯æˆ‘ä»¬ä» `source.subscribe` é‡Œ ä¼ è¿›æ¥çš„ `MapObserver`ï¼Œè€Œæ­¤æ®µä»£ç åˆå¯¹ `observer` åŒ…è£¹äº†ä¸€å±‚ã€‚

`observer.onSubscribe(sd)` å°±ä¼šæ‰§è¡Œæˆ‘ä»¬è‡ªå·± `new` å‡ºæ¥çš„ç›®æ ‡è§‚å¯Ÿè€…çš„ `onSubscribe` é‡Œçš„é€»è¾‘ã€‚

`sd.run()` è¿›å»çœ‹çœ‹æºç ï¼Œå¦‚ä¸‹ï¼š

```java
public static final class ScalarDisposable<T>
    extends AtomicInteger
    implements QueueDisposable<T>, Runnable {

        ...

        @Override
        public void run() {
            if (get() == START && compareAndSet(START, ON_NEXT)) {
              // observer å°±æ˜¯æˆ‘ä»¬ä¼ è¿›æ¥çš„ MapObserver
                observer.onNext(value);
                if (get() == ON_NEXT) {
                    lazySet(ON_COMPLETE);
                    observer.onComplete();
                }
            }
        }
    }
```

`observer.onNext(value)` çš„ `observer` å°±æ˜¯æˆ‘ä»¬ä¼ è¿›æ¥çš„ `MapObserver`ï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œ `MapObserver.onNext()`ï¼Œå¦‚ä¸‹ï¼š

```java
static final class MapObserver<T, U> extends BasicFuseableObserver<T, U> {
        final Function<? super T, ? extends U> mapper;

        MapObserver(Observer<? super U> actual, Function<? super T, ? extends U> mapper) {
            super(actual);
            this.mapper = mapper;
        }

        @Override
        public void onNext(T t) {
            if (done) {
                return;
            }

            if (sourceMode != NONE) {
                downstream.onNext(null);
                return;
            }

            U v;

            try {
                v = Objects.requireNonNull(mapper.apply(t), "The mapper function returned a null value.");
            } catch (Throwable ex) {
                fail(ex);
                return;
            }
            downstream.onNext(v);
        }

        ...
    }
```

`onNext()` é€šè¿‡ `mapper.apply(t)` å¯¹æˆ‘ä»¬çš„æ•°æ®è¿›è¡Œè½¬æ¢ï¼Œå¦‚ä¸‹

```java
public interface Function<@NonNull T, @NonNull R> {
    /**
     * Apply some calculation to the input value and return some other value.
     * @param t the input value
     * @return the output value
     * @throws Throwable if the implementation wishes to throw any type of exception
     */
    R apply(T t) throws Throwable;
}
```

ä¼ å…¥ `T` è¿”å› `R`ï¼Œè€Œè¿™ä¸ª `apply` ä¼šæ‰§è¡Œæˆ‘ä»¬å®ç°çš„é‡å†™ `apply` æ–¹æ³•çš„é‡Œé¢é€»è¾‘ã€‚

**RxJava** çš„ `map` æ“ä½œç¬¦ä½¿ç”¨äº†è£…é¥°å™¨æ¨¡å¼ï¼Œåœ¨ä¸å½±å“ä¸»æ•°æ®æµçš„æƒ…å†µä¸‹ï¼Œå¯¹éœ€è¦åŠ å·¥çš„æ•°æ®è¿›è¡ŒåŒ…è£…ï¼Œåœ¨è‡ªå·±çš„åŒ…è£…ç±»é‡Œå®Œæˆæ•°æ®çš„åŠ å·¥ã€‚

**RxJava** é‡Œçš„æ“ä½œç¬¦éå¸¸å¤šï¼Œåªè¦ä½ ç†è§£å…¶ä¸­çš„å‡ ä¸ªçš„åŸç†ï¼Œå…¶å®ƒçš„æ“ä½œç¬¦åŸç†éƒ½å·®ä¸å¤šï¼Œä¸‹é¢åˆ—å‡ºäº†åŸºæœ¬æ‰€æœ‰çš„æ“ä½œç¬¦ï¼Œå¦‚å›¾ï¼š

<div style="width: 100%; margin:auto">

![no-shadow](https://cdn.lishaoy.net/rxjava/rxjava.png "")

</div>
