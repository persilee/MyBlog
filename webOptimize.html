<!DOCTYPE html><html class="theme-next mist use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><link href="//lishaoy.net" rel="dns-prefetch"><link href="//www.lishaoy.net" rel="dns-prefetch"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="baidu-site-verification" content="7S8EhsCBzP"><meta name="google-site-verification" content="c7v-UByxWR7Pl8zy2sW85x1mKLtl7kCPtIaZyr-vjsI"><meta name="theme-color" content="#222"><meta name="description" content="李少颖的博客"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css"><meta name="keywords" content="性能优化,web,"><link rel="alternate" href="/rss2.xml" title="persilee's Blog" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico"><meta name="description" content="关于 性能优化 是个大的面，这篇文章主要涉及到 前端 的几个点，如 前端性能优化 的流程、常见技术手段、工具等。 提及 前端性能优化 ，大家应该都会想到 雅虎军规，本文会结合 雅虎军规 融入自己的了解知识，进行的总结和梳理 😜"><meta name="keywords" content="性能优化,web"><meta property="og:type" content="article"><meta property="og:title" content="前端性能优化"><meta property="og:url" content="https://www.h.lishaoy.net/webOptimize.html"><meta property="og:site_name" content="persilee&#39;s Blog"><meta property="og:description" content="关于 性能优化 是个大的面，这篇文章主要涉及到 前端 的几个点，如 前端性能优化 的流程、常见技术手段、工具等。 提及 前端性能优化 ，大家应该都会想到 雅虎军规，本文会结合 雅虎军规 融入自己的了解知识，进行的总结和梳理 😜"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="https://cdn.lishaoy.net/webOptimize/Optimize.png"><meta property="og:image" content="https://cdn.lishaoy.net/webOptimize/concatJs.png"><meta property="og:image" content="https://cdn.lishaoy.net/webOptimize/concatCss.png"><meta property="og:image" content="https://cdn.lishaoy.net/webOptimize/concatJs2.png"><meta property="og:image" content="https://cdn.lishaoy.net/webOptimize/minImages.png"><meta property="og:image" content="https://cdn.lishaoy.net/webOptimize/minImages1.png"><meta property="og:image" content="https://cdn.lishaoy.net/webOptimize/webCache3.png"><meta property="og:image" content="https://cdn.lishaoy.net/webOptimize/webCache4.png"><meta property="og:image" content="https://cdn.lishaoy.net/webOptimize/webCache2.png"><meta property="og:image" content="https://cdn.lishaoy.net/webOptimize/serviceWorker.png"><meta property="og:image" content="https://cdn.lishaoy.net/webOptimize/serviceWorker1.png"><meta property="og:image" content="https://cdn.lishaoy.net/webOptimize/storageQuota.png"><meta property="og:image" content="https://cdn.lishaoy.net/webOptimize/serviceWorker2.png"><meta property="og:image" content="https://cdn.lishaoy.net/webOptimize/serviceWorker3.png"><meta property="og:image" content="https://cdn.lishaoy.net/webOptimize/Optimize.png"><meta property="og:updated_time" content="2018-11-04T21:55:54.947Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="前端性能优化"><meta name="twitter:description" content="关于 性能优化 是个大的面，这篇文章主要涉及到 前端 的几个点，如 前端性能优化 的流程、常见技术手段、工具等。 提及 前端性能优化 ，大家应该都会想到 雅虎军规，本文会结合 雅虎军规 融入自己的了解知识，进行的总结和梳理 😜"><meta name="twitter:image" content="https://cdn.lishaoy.net/webOptimize/Optimize.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",sidebar:{position:"left",display:"post",offset:12,offset_float:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!0,tabs:!0,motion:!0,duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="https://www.h.lishaoy.net/webOptimize.html"><title>前端性能优化 | persilee's Blog</title><link href="https://cdn.lishaoy.net/css/all-050d732208.css" rel="stylesheet" type="text/css"><link rel="stylesheet" href="/video/video-js.css"></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div id="loader"><div></div></div><div class="container sidebar-position-left page-post-detail"><div class="headband"></div> <a href="https://github.com/persilee" class="github-corner" aria-label="View source on Github"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513;color:#fff;position:absolute;top:0;border:0;left:0;transform:scale(-1,1)" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style></a><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">persilee's Blog</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">Blog</h1></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" class="faa-parent animated-hover" rel="section"><i class="menu-item-icon fa fa-fw fa-home faa-wrench"></i><br> 首页</a></li><li class="menu-item menu-item-links"><a href="/links/" class="faa-parent animated-hover" rel="section"><i class="menu-item-icon fa fa-fw fa-link faa-shake"></i><br> 友链</a></li><li class="menu-item menu-item-guestbook"><a href="/guestbook/" class="faa-parent animated-hover" rel="section"><i class="menu-item-icon fa fa-fw fa-comment-o faa-tada"></i><br> 留言板</a></li><li class="menu-item menu-item-archives"><a href="/archives/" class="faa-parent animated-hover" rel="section"><i class="menu-item-icon fa fa-fw fa-archive faa-float"></i><br> 归档</a></li><li class="menu-item menu-item-about"><a href="/about/" class="faa-parent animated-hover" rel="section"><i class="menu-item-icon fa fa-fw fa-user faa-horizontal"></i><br> 关于</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger faa-parent animated-hover"><i class="menu-item-icon fa fa-search faa-burst fa-fw"></i><br> 搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"> <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-date" data-datetime="2018-11-05T05:55:54+08:00"><div class="post-time-text">11月</div><div class="post-time-count">05</div><div class="text-desc"><div class="date-text">更新于</div><div class="post-tiem">11月05</div><div class="post-year">2018</div></div></div><div class="post-badge"> <span class="post-category"><span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/性能/" itemprop="url" rel="index"><span itemprop="name">性能</span></a></span></span></div><div class="post-block"><link itemprop="mainEntityOfPage" href="https://www.h.lishaoy.net/webOptimize.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="李少颖（persilee）"><meta itemprop="description" content=""><meta itemprop="image" content="https://cdn.lishaoy.net/images/lsy.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="persilee's Blog"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">前端性能优化</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="发表于" itemprop="dateCreated datePublished" datetime="2018-05-10T12:55:59+08:00">2018-05-10</time> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">更新于</span> <time title="更新于" itemprop="dateModified" datetime="2018-11-05T05:55:54+08:00">2018-11-05</time></span> <span id="/webOptimize.html" class="leancloud_visitors" data-flag-title="前端性能优化"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">热度</span><span class="leancloud-visitors-count"></span> ℃</span><div class="post-wordcount"> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-pencil-square-o"></i></span> <span class="post-meta-item-text">字数统计：</span> <span title="字数统计：">4,572 (字)</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时长：</span> <span title="阅读时长：">18 (分钟)</span></div></div></header><div class="post-body" itemprop="articleBody"> <span itemprop="image" itemscope="" itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="https://cdn.lishaoy.net/webOptimize/Optimize.png" class="full-image" alt="web optimize" title="web optimize"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span><p>关于 <strong>性能优化</strong> 是个大的面，这篇文章主要涉及到 <strong>前端</strong> 的几个点，如 <strong>前端性能优化</strong> 的流程、常见技术手段、工具等。</p><p>提及 <strong>前端性能优化</strong> ，大家应该都会想到 <strong>雅虎军规</strong>，本文会结合 <strong>雅虎军规</strong> 融入自己的了解知识，进行的总结和梳理 😜</p><a id="more"></a><p>首先，我们先来看看 👀 <strong>雅虎军规</strong> 的 <strong>35</strong> 条。</p><div class="note info"><ol><li>尽量减少 HTTP 请求个数——须权衡</li><li>使用 <strong>CDN</strong>（内容分发网络）</li><li>为文件头指定 Expires 或 Cache-Control ，使内容具有缓存性。</li><li>避免空的 src 和 href</li><li>使用 gzip 压缩内容</li><li>把 CSS 放到顶部</li><li>把 JS 放到底部</li><li>避免使用 CSS 表达式</li><li>将 CSS 和 JS 放到外部文件中</li><li>减少 DNS 查找次数</li><li>精简 CSS 和 JS</li><li>避免跳转</li><li>剔除重复的 JS 和 CSS</li><li>配置 ETags</li><li>使 AJAX 可缓存</li><li>尽早刷新输出缓冲</li><li>使用 GET 来完成 AJAX 请求</li><li>延迟加载</li><li>预加载</li><li>减少 DOM 元素个数</li><li>根据域名划分页面内容</li><li>尽量减少 iframe 的个数</li><li>避免 404</li><li>减少 Cookie 的大小</li><li>使用无 cookie 的域</li><li>减少 DOM 访问</li><li>开发智能事件处理程序</li><li>用<link> 代替 @import</li><li>避免使用滤镜</li><li>优化图像</li><li>优化 CSS Spirite</li><li>不要在 HTML 中缩放图像——须权衡</li><li>favicon.ico要小而且可缓存</li><li>保持单个内容小于25K</li><li>打包组件成复合文本</li></ol></div><p>如对 <strong>雅虎军规</strong> 的具体细则内容不是很了解，可自行去各搜索 🔍 引擎 ，搜索 <strong>雅虎军规</strong> 了解详情。</p><h2 id="压缩-合并"><a href="#压缩-合并" class="headerlink" title="压缩 合并"></a>压缩 合并</h2><p>对于 <strong>前端性能优化</strong> 自然要关注 <strong>首屏</strong> 打开速度，而这个速度，很大因素是花费在网络请求上，那么怎么减少网络请求的时间呢？</p><ul><li>减少网络请求次数</li><li>减小文件体积</li><li>使用 <code>CDN</code> 加速</li></ul><p>所以 <strong>压缩、合并</strong> 就是一个解决方案，当然可以用 <code>gulp</code> 、 <code>webpack</code> 、 <code>grunt</code> 等构建工具 <strong>压缩、合并</strong></p><h3 id="JS、CSS-压缩-合并"><a href="#JS、CSS-压缩-合并" class="headerlink" title="JS、CSS 压缩 合并"></a><code>JS、CSS</code> 压缩 合并</h3><p>例如：<code>gulp js、css</code> 压缩、合并代码如下 👇</p><figure class="highlight javascript"><figcaption><span>javascript</span><a href="https://lishaoy.net/webOptimize.html#JS、CSS-压缩-合并" target="_blank" rel="noopener">gulpfile.js</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//压缩、合并js</span></span><br><span class="line">gulp.task(<span class="string">'scripts'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> gulp.src([</span><br><span class="line">        <span class="string">'./public/lib/fastclick/lib/fastclick.min.js'</span>,</span><br><span class="line">        <span class="string">'./public/lib/jquery_lazyload/jquery.lazyload.js'</span>,</span><br><span class="line">        <span class="string">'./public/lib/velocity/velocity.min.js'</span>,</span><br><span class="line">        <span class="string">'./public/lib/velocity/velocity.ui.min.js'</span>,</span><br><span class="line">        <span class="string">'./public/lib/fancybox/source/jquery.fancybox.pack.js'</span>,</span><br><span class="line">        <span class="string">'./public/js/src/utils.js'</span>,</span><br><span class="line">        <span class="string">'./public/js/src/motion.js'</span>,</span><br><span class="line">        <span class="string">'./public/js/src/scrollspy.js'</span>,</span><br><span class="line">        <span class="string">'./public/js/src/post-details.js'</span>,</span><br><span class="line">        <span class="string">'./public/js/src/bootstrap.js'</span>,</span><br><span class="line">        <span class="string">'./public/js/src/push.js'</span>,</span><br><span class="line">        <span class="string">'./public/live2dw/js/perTips.js'</span>,</span><br><span class="line">        <span class="string">'./public/live2dw/lib/L2Dwidget.min.js'</span>,</span><br><span class="line">        <span class="string">'./public/js/src/love.js'</span>,</span><br><span class="line">        <span class="string">'./public/js/src/busuanzi.pure.mini.js'</span>,</span><br><span class="line">        <span class="string">'./public/js/src/activate-power-mode.js'</span></span><br><span class="line">    ]).pipe(concat(<span class="string">'all.js'</span>)).pipe(minify()).pipe(gulp.dest(<span class="string">'./public/dist/'</span>));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 压缩、合并 CSS </span></span><br><span class="line">gulp.task(<span class="string">'css'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> gulp.src([</span><br><span class="line">        <span class="string">'./public/lib/font-awesome/css/font-awesome.min.css'</span>,</span><br><span class="line">        <span class="string">'./public/lib/fancybox/source/jquery.fancybox.css'</span>,</span><br><span class="line">        <span class="string">'./public/css/main.css'</span>,</span><br><span class="line">        <span class="string">'./public/css/lib.css'</span>,</span><br><span class="line">        <span class="string">'./public/live2dw/css/perTips.css'</span></span><br><span class="line">    ]).pipe(concat(<span class="string">'all.css'</span>)).pipe(minify()).pipe(gulp.dest(<span class="string">'./public/dist/'</span>));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>然后，再把 <strong>压缩、合并</strong> 的 <code>JS、CSS</code> 放入 <code>CDN</code> , 👀 看看效果如何</p><p>如图： <em><strong>压缩、合并</strong> 且放入 <code>CND</code> 之后的效果</em></p><p><img src="https://cdn.lishaoy.net/webOptimize/concatJs.png" alt="首页请求速度(js)" width="100%" title="首页请求速度(js)" align="center"></p><p><img src="https://cdn.lishaoy.net/webOptimize/concatCss.png" alt="首页请求速度(css)" width="100%" title="首页请求速度(css)" align="center"></p><p>以上是 <a href="https://lishaoy.net" target="_blank" rel="noopener">lishaoy.net</a> 清除缓存后的 <strong>首页</strong> 请求速度。</p><p>可见，请求时间是 <strong>4.59 s</strong> ，总请求个数 <strong>51</strong> ， 而 <code>js</code> 的请求个数是 <strong>8</strong> ，<code>css</code> 的请求个数是 <strong>3</strong> <em>（其实就 all.css 一个，其它 2 个是 Google浏览器加载的）</em>， 而没使用 <strong>压缩、合并</strong> 时候，请求时间是 <strong>10</strong> 多秒，总请求个数有 <strong>70</strong> 多个，<code>js</code> 的请求个数是 <strong>20</strong> 多个 ，对比请求时间 <strong>性能</strong> 提升 <strong>1倍</strong> 多</p><p>如图：<em>有缓存下的首页效果</em></p><p><img src="https://cdn.lishaoy.net/webOptimize/concatJs2.png" alt="首页请求速度（缓存）" width="100%" title="首页请求速度（缓存）" align="center"></p><p>基本都是秒开 😝</p><div class="note warning"><p><em>Tips：在 <strong>压缩、合并</strong> 后，单个文件控制在 25 ~ 30 KB左右，同一个域下，最好不要多于5个资源</em></p></div><h3 id="图片压缩、合并"><a href="#图片压缩、合并" class="headerlink" title="图片压缩、合并"></a>图片压缩、合并</h3><p>例如：<code>gulp</code> 图片压缩代码如下 👇</p><figure class="highlight javascript"><figcaption><span>javascript</span><a href="https://lishaoy.net/webOptimize.html#图片压缩、合并" target="_blank" rel="noopener">gulpfile.js</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//压缩image</span></span><br><span class="line">gulp.task(<span class="string">'imagemin'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    gulp.src(<span class="string">'./public/**/*.&#123;png,jpg,gif,ico,jpeg&#125;'</span>)</span><br><span class="line">        .pipe(imagemin())</span><br><span class="line">        .pipe(gulp.dest(<span class="string">'./public'</span>));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>图片的合并可以采用 <code>CSS Spirite</code>，方法就是把一些小图用 <code>PS</code> 合成一张图，用 <code>css</code> 定位显示每张图片的位置</p><figure class="highlight css"><figcaption><span>css</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.top_right</span> <span class="selector-class">.phone</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">url</span>(../images/top_right.png) no-repeat <span class="number">7px</span> -<span class="number">17px</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">0</span> <span class="number">38px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.top_right</span> <span class="selector-class">.help</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">url</span>(../images/top_right.png) no-repeat <span class="number">0</span> -<span class="number">47px</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">0</span> <span class="number">38px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后，把 <strong>压缩</strong> 的图片放入 <code>CDN</code> , 👀 看看，效果如何</p><p><img src="https://cdn.lishaoy.net/webOptimize/minImages.png" alt="首页请求速度（images）" width="100%" title="首页请求速度（images）" align="center"></p><p>可见，请求时间是 <strong>1.70 s</strong> ,总请求个数 <strong>50</strong> ， 而 <code>img</code> 的请求个数是 <strong>15</strong> <em>（这里因为首页都是大图，就没有合并，只是压缩了）</em> ，但是，效果很好 😀 ，从 <strong>4.59 s</strong> 缩短到 <strong>1.70 s</strong>, 性能又提升一倍。</p><p>再看看有缓存情况如何 😏</p><p><img src="https://cdn.lishaoy.net/webOptimize/minImages1.png" alt="首页请求速度（images 缓存）" width="100%" title="首页请求速度（images 缓存）" align="center"></p><p>请求时间是 <strong>1.05 s</strong> ，有缓存和无缓存基本差不多</p><div class="note warning"><p><em>Tips：大的图片在不同终端，应该使用不同分辨率，而不应该使用缩放（百分比）</em></p></div><p>整个 <strong>压缩、合并</strong> <em>（js、css、img）</em> 再放入 <code>CDN</code> ，请求时间从 <strong>10</strong> 多秒 ，到最后的 <strong>1.70 s</strong> ，性能提升 <strong>5</strong> 倍多，可见，这个操作必要性。</p><hr><h2 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h2><p>缓存会根据请求保存输出内容的副本，例如 <strong>页面、图片、文件</strong>，当下一个请求来到的时候:如果是相同的<code>URL</code>，缓存直接使 用本地的副本响应访问请求，而不是向源服务器再次发送请求。因此，可以从以下 <strong>2</strong> 个方面提升性能。</p><ul><li>减少相应延迟，提升响应时间</li><li>减少网络带宽消耗，节省流量</li></ul><p>我们用两幅图来了解下浏览器的 <strong>缓存机制</strong></p><p><strong>浏览器第一次请求</strong></p><p><img src="https://cdn.lishaoy.net/webOptimize/webCache3.png" alt="no-shadow" title="第一次请求"></p><p><strong>浏览器再次请求</strong></p><p><img src="https://cdn.lishaoy.net/webOptimize/webCache4.png" alt="no-shadow" title="再次请求"></p><p>从以上两幅图中，可以清楚的了解浏览器 <strong>缓存</strong> 的过程。 首次访问一个 <code>URL</code> ，没有 <strong>缓存</strong> ，但是，服务器会响应一些 <code>header</code> 信息，如：<code>expires、cache-control、last-modified、etag</code> 等，来记录下次请求是否缓存、如何缓存。 再次访问这个 <code>URL</code> 时候，浏览器会根据首次访问返回的 <code>header</code> 信息，来决策是否缓存、如何缓存。 我们重点来分析下第二幅图，其实是分两条线路，如下 👇</p><ul><li><strong>第一条线路：</strong> 当浏览器再次访问某个 <code>URL</code> 时，会先获取资源的 <code>header</code> 信息，判断是否命中强缓存 <em>（cache-control和expires）</em> ，如命中，直接从缓存获取资源，包括响应的 <code>header</code> 信息 <em>（请求不会和服务器通信）</em> ，也就是 <strong>强缓存</strong> ，如图</li></ul><p><img src="https://cdn.lishaoy.net/webOptimize/webCache2.png" alt="强缓存" width="100%" title="强缓存" align="center"></p><ul><li><strong>第二条线路：</strong> 如没有命中 <strong>强缓存</strong> ，浏览器会发送请求到服务器，请求会携带第一次请求返回的有关缓存的 <code>header</code> 信息 <em>（Last-Modified/If-Modified-Since和Etag/If-None-Match）</em> ，由服务器根据请求中的相关 <code>header</code> 信息来比对结果是否协商缓存命中；若命中，则服务器返回新的响应 <code>header</code> 信息更新缓存中的对应 <code>header</code> 信息，但是并不返回资源内容，它会告知浏览器可以直接从缓存获取；否则返回最新的资源内容，也就是 <strong>协商缓存</strong>。</li></ul><p>现在，我们了解到浏览器缓存机制分为 <strong>强缓存、协商缓存</strong>，再来看看他们的区别 👇</p><table><thead><tr><th style="text-align:center">缓存策略</th><th style="text-align:center">获取资源形式</th><th style="text-align:center">状态码</th><th style="text-align:center">发送请求到服务器</th></tr></thead><tbody><tr><td style="text-align:center">强缓存</td><td style="text-align:center">从缓存取</td><td style="text-align:center">200（from memory cache）</td><td style="text-align:center">否，直接从缓存取</td></tr><tr><td style="text-align:center">协商缓存</td><td style="text-align:center">从缓存取</td><td style="text-align:center">304（not modified）</td><td style="text-align:center">是，通过服务器来告知缓存是否可用</td></tr></tbody></table><h3 id="强缓存"><a href="#强缓存" class="headerlink" title="强缓存"></a>强缓存</h3><p>与强缓存相关的 <code>header</code> 字段有两个：</p><h4 id="expires"><a href="#expires" class="headerlink" title="expires"></a>expires</h4><p><strong>expires：</strong> 这是 <code>http1.0</code> 时的规范，它的值为一个绝对时间的 <strong>GMT</strong> 格式的时间字符串，如 <code>Mon, 10 Jun 2015 21:31:12 GMT</code> ，如果发送请求的时间在 <strong>expires</strong> 之前，那么本地缓存始终有效，否则就会发送请求到服务器来获取资源</p><h4 id="cache-control"><a href="#cache-control" class="headerlink" title="cache-control"></a>cache-control</h4><p><strong>cache-control:</strong> <code>max-age=number</code> ，这是 <code>http1.1</code> 时出现的 <code>header</code> 信息，主要是利用该字段的 <code>max-age</code> 值来进行判断，它是一个相对值；资源第一次的请求时间和 <strong>Cache-Control</strong> 设定的有效期，计算出一个资源过期时间，再拿这个过期时间跟当前的请求时间比较，如果请求时间在过期时间之前，就能命中缓存，否则未命中， <strong>cache-control</strong> 除了该字段外，还有下面几个比较常用的设置值：</p><ul><li><strong>no-cache：</strong> 不使用本地缓存。需要使用缓存协商，先与服务器确认返回的响应是否被更改，如果之前的响应中存在 <code>ETag</code> ，那么请求的时候会与服务端验证，如果资源未被更改，则可以避免重新下载。</li><li><strong>no-store：</strong> 直接禁止游览器缓存数据，每次用户请求该资源，都会向服务器发送一个请求，每次都会下载完整的资源。</li><li><strong>public：</strong> 可以被所有的用户缓存，包括终端用户和 <code>CDN</code> 等中间代理服务器。</li><li><strong>private：</strong> 只能被终端用户的浏览器缓存，不允许 <code>CDN</code> 等中继缓存服务器对其缓存。</li></ul><div class="note warning"><p><em>Tips：如果 cache-control 与 expires 同时存在的话，cache-control 的优先级高于 expires</em></p></div><h3 id="协商缓存"><a href="#协商缓存" class="headerlink" title="协商缓存"></a>协商缓存</h3><p>协商缓存都是由浏览器和服务器协商，来确定是否缓存，协商主要通过下面两组 <code>header</code> 字段，这两组字段都是成对出现的，即第一次请求的响应头带上某个字段 <em>（ <strong>Last-Modified</strong> 或者 <strong>Etag</strong> ）</em> ，则后续请求会带上对应的请求字段 <em>（<strong>If-Modified-Since</strong> 或者 <strong>If-None-Match</strong> ）</em> ，若响应头没有 <strong>Last-Modified</strong> 或者 <strong>Etag</strong> 字段，则请求头也不会有对应的字段。</p><h4 id="Last-Modified-If-Modified-Since"><a href="#Last-Modified-If-Modified-Since" class="headerlink" title="Last-Modified/If-Modified-Since"></a>Last-Modified/If-Modified-Since</h4><p>二者的值都是 <code>GMT</code> 格式的时间字符串，具体过程：</p><ul><li><p>浏览器第一次跟服务器请求一个资源，服务器在返回这个资源的同时，在 <code>respone</code> 的 <code>header</code> 加上 <strong>Last-Modified</strong> 字段，这个 <code>header</code> 字段表示这个资源在服务器上的最后修改时间</p></li><li><p>浏览器再次跟服务器请求这个资源时，在 <code>request</code> 的 <code>header</code> 上加上 <strong>If-Modified-Since</strong> 字段，这个 <code>header</code> 字段的值就是上一次请求时返回的 <strong>Last-Modified</strong> 的值</p></li><li><p>服务器再次收到资源请求时，根据浏览器传过来 <strong>If-Modified-Since</strong> 和资源在服务器上的最后修改时间判断资源是否有变化，如果没有变化则返回 <code>304 Not Modified</code> ，但是不会返回资源内容；如果有变化，就正常返回资源内容。当服务器返回 <code>304 Not Modified</code> 的响应时，<code>response header</code> 中不会再添加 <strong>Last-Modified的header</strong> ，因为既然资源没有变化，那么 <strong>Last-Modified</strong> 也就不会改变，这是服务器返回 <code>304</code> 时的 <code>response header</code></p></li><li><p>浏览器收到 <code>304</code> 的响应后，就会从缓存中加载资源</p></li><li><p>如果协商缓存没有命中，浏览器直接从服务器加载资源时，<strong>Last-Modified</strong> 的 <code>Header</code> 在重新加载的时候会被更新，下次请求时，<strong>If-Modified-Since</strong> 会启用上次返回的<strong>Last-Modified</strong> 值</p></li></ul><h4 id="Etag-If-None-Match"><a href="#Etag-If-None-Match" class="headerlink" title="Etag/If-None-Match"></a>Etag/If-None-Match</h4><p>这两个值是由服务器生成的每个资源的唯一标识字符串，只要资源有变化就这个值就会改变；其判断过程与 <strong>Last-Modified、If-Modified-Since</strong> 类似，与 <strong>Last-Modified</strong> 不一样的是，当服务器返回 <code>304 Not Modified</code> 的响应时，由于 <strong>ETag</strong> 重新生成过，<code>response header</code> 中还会把这个 <strong>ETag</strong> 返回，即使这个 <strong>ETag</strong> 跟之前的没有变化。</p><div class="note warning"><p><em>Tips：Last-Modified与ETag是可以一起使用的，服务器会优先验证ETag，一致的情况下，才会继续比对Last-Modified，最后才决定是否返回304。</em></p></div><h3 id="Service-Worker"><a href="#Service-Worker" class="headerlink" title="Service Worker"></a>Service Worker</h3><h4 id="什么是-Service-Worker"><a href="#什么是-Service-Worker" class="headerlink" title="什么是 Service Worker"></a>什么是 Service Worker</h4><blockquote><p><strong>Service Worker</strong> 本质上充当Web应用程序与浏览器之间的代理服务器，也可以在网络可用时作为浏览器和网络间的代理。它们旨在（除其他之外）使得能够创建有效的离线体验，拦截网络请求并基于网络是否可用以及更新的资源是否驻留在服务器上来采取适当的动作。他们还允许访问推送通知和后台同步API。</p><footer><strong>Service Worker API</strong><cite><a href="http://sethgodin.typepad.com/seths_blog/2009/07/welcome-to-island-marketing.html" target="_blank" rel="noopener">developer.mozilla.org</a></cite></footer></blockquote><p><br> <strong>Service worker</strong> 可以解决目前离线应用的问题，同时也可以做更多的事。 <strong>Service Worker</strong> 可以使你的应用先访问本地缓存资源，所以在离线状态时，在没有通过网络接收到更多的数据前，仍可以提供基本的功能（一般称之为 Offline First）。这是原生APP 本来就支持的功能，这也是相比于 <code>web app</code> ，原生 <code>app</code> 更受青睐的主要原因</p><p>再来看看 👀 <strong>service worker</strong> 能做些什么</p><ul><li>后台消息传递</li><li>网络代理，转发请求，伪造响应</li><li>离线缓存</li><li>消息推送</li><li>…</li></ul><div class="note success"><p><strong><em>本文主要以（<a href="https://lishaoy.net" target="_blank" rel="noopener">lishaoy.net</a>）资源缓存为例,阐述下 service worker如何工作</em></strong></p></div><h4 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h4><p><strong>service worker</strong> 初次安装的生命周期，如图 🌠</p><p><img src="https://cdn.lishaoy.net/webOptimize/serviceWorker.png" alt="no-shadow" title="sw生命周期"></p><p>从上 👆 图可知，<strong>service worker</strong> 工作的流程：</p><ol><li><strong>安装：</strong> <code>service worker URL</code> 通过 <code>serviceWorkerContainer.register()</code> 来获取和注册。</li><li><strong>激活：</strong> 当 <code>service worker</code> 安装完成后，会接收到一个激活事件(activate event)。 <code>onactivate</code> 主要用途是清理先前版本的 <code>service worker</code> 脚本中使用的资源。</li><li><strong>监听：</strong> 两种状态<ul><li>终止以节省内存；</li><li>监听获取 <code>fetch</code> 和消息 <code>message</code> 事件。</li></ul></li><li><strong>销毁：</strong> 是否销毁由浏览器决定，如果一个 <code>service worker</code> 长期不使用或者机器内存有限，则可能会销毁这个 <code>worker</code> 。</li></ol><div class="note warning"><p><em>Tips：激活成功之后，在 Chrome 浏览器里，可以访问 chrome://inspect/#service-workers和 chrome://serviceworker-internals/ 可以查看到当前运行的service worker ，如图 👇。</em></p></div><p><img src="https://cdn.lishaoy.net/webOptimize/serviceWorker1.png" alt="service worker" width="100%" title="service worker" align="center"></p><p><strong>现在，我们来写个简单的例子 🌰</strong></p><h4 id="注册-service-worker"><a href="#注册-service-worker" class="headerlink" title="注册 service worker"></a>注册 service worker</h4><p>要安装 <code>service worker</code> ，你需要在你的页面上注册它。这个步骤告诉浏览器你的 <code>service worker</code> 脚本在哪里。</p><figure class="highlight javascript"><figcaption><span>javascript</span><a href="https://lishaoy.net/webOptimize.html#注册-service-worker" target="_blank" rel="noopener">app.js</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="string">'serviceWorker'</span> <span class="keyword">in</span> navigator) &#123;</span><br><span class="line">  navigator.serviceWorker.register(<span class="string">'/sw.js'</span>).then(<span class="function"><span class="keyword">function</span>(<span class="params">registration</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Registration was successful</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'ServiceWorker registration successful with scope: '</span>,    registration.scope);</span><br><span class="line">  &#125;).catch(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// registration failed :(</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'ServiceWorker registration failed: '</span>, err);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面的代码检查 <code>service worker API</code> 是否可用，如果可用，<code>service worker /sw.js</code> 被注册。如果这个 <code>service worker</code> 已经被注册过，浏览器会自动忽略上面的代码。</p><h4 id="激活-service-worker"><a href="#激活-service-worker" class="headerlink" title="激活 service worker"></a>激活 service worker</h4><p>在你的 <code>service worker</code> 注册之后，浏览器会尝试为你的页面或站点安装并激活它。 <code>install</code> 事件会在安装完成之后触发。<code>install</code> 事件一般是被用来填充你的浏览器的离线缓存能力。你需要为 <code>install</code> 事件定义一个 <code>callback</code> ，并决定哪些文件你想要缓存.</p><figure class="highlight javascript"><figcaption><span>javascript</span><a href="https://lishaoy.net/webOptimize.html#激活-service-worker" target="_blank" rel="noopener">sw.js</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The files we want to cache</span></span><br><span class="line"><span class="keyword">var</span> CACHE_NAME = <span class="string">'my-site-cache-v1'</span>;</span><br><span class="line"><span class="keyword">var</span> urlsToCache = [</span><br><span class="line">  <span class="string">'/'</span>,</span><br><span class="line">  <span class="string">'/css/main.css'</span>,</span><br><span class="line">  <span class="string">'/js/main.js'</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">self.addEventListener(<span class="string">'install'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Perform install steps</span></span><br><span class="line">  event.waitUntil(</span><br><span class="line">    caches.open(CACHE_NAME)</span><br><span class="line">      .then(<span class="function"><span class="keyword">function</span>(<span class="params">cache</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'Opened cache'</span>);</span><br><span class="line">        <span class="keyword">return</span> cache.addAll(urlsToCache);</span><br><span class="line">      &#125;)</span><br><span class="line">  );</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>在我们的 <code>install callback</code> 中，我们需要执行以下步骤：</p><ul><li>开启一个缓存</li><li>缓存我们的文件</li><li>决定是否所有的资源是否要被缓存</li></ul><p>上面的代码中，我们通过 <code>caches.open</code> 打开我们指定的 <code>cache</code> 文件名，然后我们调用 <code>cache.addAll</code> 并传入我们的文件数组。这是通过一连串 <code>promise</code> <em>（caches.open 和 cache.addAll）</em> 完成的。<code>event.waitUntil</code> 拿到一个 <code>promise</code> 并使用它来获得安装耗费的时间以及是否安装成功。</p><h4 id="监听-service-worker"><a href="#监听-service-worker" class="headerlink" title="监听 service worker"></a>监听 service worker</h4><p>现在我们已经将你的站点资源缓存了，你需要告诉 <code>service worker</code> 让它用这些缓存内容来做点什么。有了 <code>fetch</code> 事件，这是很容易做到的。</p><p>每次任何被 <code>service worker</code> 控制的资源被请求到时，都会触发 <code>fetch</code> 事件，我们可以给 <code>service worker</code> 添加一个 <code>fetch</code> 的事件监听器，接着调用 <code>event</code> 上的 <code>respondWith()</code> 方法来劫持我们的 <strong>HTTP</strong> 响应，然后你用可以用自己的方法来更新他们。</p><figure class="highlight javascript"><figcaption><span>javascript</span><a href="https://lishaoy.net/webOptimize.html#监听-service-worker" target="_blank" rel="noopener">sw.js</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">self.addEventListener(<span class="string">'fetch'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">  event.respondWith(</span><br><span class="line">    caches.match(event.request);</span><br><span class="line">  );</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><code>caches.match(event.request)</code> 允许我们对网络请求的资源和 <code>cache</code> 里可获取的资源进行匹配，查看是否缓存中有相应的资源。这个匹配通过 <code>url</code> 和 <code>vary header</code> 进行，就像正常的 <strong>HTTP</strong> 请求一样。</p><p>那么，我们如何返回 <code>request</code> 呢，下面 👇 就是一个例子 🌰</p><figure class="highlight javascript"><figcaption><span>javascript</span><a href="https://lishaoy.net/webOptimize.html#监听-service-worker" target="_blank" rel="noopener">sw.js</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">self.addEventListener(<span class="string">'fetch'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">  event.respondWith(</span><br><span class="line">    caches.match(event.request)</span><br><span class="line">      .then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// Cache hit - return response</span></span><br><span class="line">        <span class="keyword">if</span> (response) &#123;</span><br><span class="line">          <span class="keyword">return</span> response;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> fetch(event.request);</span><br><span class="line">      &#125;</span><br><span class="line">    )</span><br><span class="line">  );</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>上面的代码里我们定义了 <code>fetch</code> 事件，在 <code>event.respondWith</code> 里，我们传入了一个由 <code>caches.match</code> 产生的 <code>promise.caches.match</code> 查找 <code>request</code> 中被 <code>service worker</code> 缓存命中的 <code>response</code> 。 如果我们有一个命中的 <code>response</code> ，我们返回被缓存的值，否则我们返回一个实时从网络请求 <code>fetch</code> 的结果。</p><h4 id="sw-toolbox"><a href="#sw-toolbox" class="headerlink" title="sw-toolbox"></a>sw-toolbox</h4><div class="note success"><p><em>当然，我也可以使用第三方库，例如：<a href="https://lishaoy.net" target="_blank" rel="noopener">lishaoy.net</a> 使用了 <strong>sw-toolbox</strong>。</em></p></div><p><strong>sw-toolbox</strong> 使用非常简单，下面 👇 就是 <a href="https://lishaoy.net" target="_blank" rel="noopener">lishaoy.net</a> 的一个例子 🌰</p><figure class="highlight javascript"><figcaption><span>javascript</span><a href="https://lishaoy.net/webOptimize.html#sw-toolbox" target="_blank" rel="noopener">persilee.js</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"serviceWorker"</span> <span class="keyword">in</span> navigator ? navigator.serviceWorker.register(<span class="string">'/sw.js'</span>).then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  navigator.serviceWorker.controller ? <span class="built_in">console</span>.log(<span class="string">"Assets cached by the controlling service worker."</span>) : <span class="built_in">console</span>.log(<span class="string">"Please reload this page to allow the service worker to handle network operations."</span>)</span><br><span class="line">&#125;).catch(<span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"ERROR: "</span> + e)</span><br><span class="line">&#125;) : <span class="built_in">console</span>.log(<span class="string">"Service workers are not supported in the current browser."</span>)</span><br></pre></td></tr></table></figure><p>以上是 <strong>注册</strong> 一个 <code>service woker</code></p><figure class="highlight javascript"><figcaption><span>javascript</span><a href="https://lishaoy.net/webOptimize.html#sw-toolbox" target="_blank" rel="noopener">sw.js</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">"use strict"</span>;</span><br><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> cacheVersion = <span class="string">"20180527"</span>;</span><br><span class="line">    <span class="keyword">var</span> staticImageCacheName = <span class="string">"image"</span> + cacheVersion;</span><br><span class="line">    <span class="keyword">var</span> staticAssetsCacheName = <span class="string">"assets"</span> + cacheVersion;</span><br><span class="line">    <span class="keyword">var</span> contentCacheName = <span class="string">"content"</span> + cacheVersion;</span><br><span class="line">    <span class="keyword">var</span> vendorCacheName = <span class="string">"vendor"</span> + cacheVersion;</span><br><span class="line">    <span class="keyword">var</span> maxEntries = <span class="number">100</span>;</span><br><span class="line">    self.importScripts(<span class="string">"/lib/sw-toolbox/sw-toolbox.js"</span>);</span><br><span class="line">    self.toolbox.options.debug = <span class="literal">false</span>;</span><br><span class="line">    self.toolbox.options.networkTimeoutSeconds = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    self.toolbox.router.get(<span class="string">"/images/(.*)"</span>, self.toolbox.cacheFirst, &#123;</span><br><span class="line">        cache: &#123;</span><br><span class="line">            name: staticImageCacheName,</span><br><span class="line">            maxEntries: maxEntries</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    self.toolbox.router.get(<span class="string">'/js/(.*)'</span>, self.toolbox.cacheFirst, &#123;</span><br><span class="line">        cache: &#123;</span><br><span class="line">            name: staticAssetsCacheName,</span><br><span class="line">            maxEntries: maxEntries</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    self.toolbox.router.get(<span class="string">'/css/(.*)'</span>, self.toolbox.cacheFirst, &#123;</span><br><span class="line">        cache: &#123;</span><br><span class="line">            name: staticAssetsCacheName,</span><br><span class="line">            maxEntries: maxEntries</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    self.addEventListener(<span class="string">"install"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> event.waitUntil(self.skipWaiting())</span><br><span class="line">    &#125;);</span><br><span class="line">    self.addEventListener(<span class="string">"activate"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> event.waitUntil(self.clients.claim())</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure><p>就这样搞定了 🍉 <em>(具体的用法可以去 <a href="https://googlechromelabs.github.io/sw-toolbox/api.html#main" target="_blank" rel="noopener">sw-toolbox</a> 查看)</em></p><p>有的同学就问，<code>service worker</code> 这么好用，这个缓存空间到底是多大？其实，在 <strong>Chrome</strong> 可以看到，如图</p><p><img src="https://cdn.lishaoy.net/webOptimize/storageQuota.png" alt="fstorage quota" width="100%" title="storage quota" align="center"></p><p>可以看到，大概有 <strong>30G</strong> ，我的站点只用了 <strong>183MB</strong> ，完全够用了 🍓</p><p>最后，来两张图</p><p><img src="https://cdn.lishaoy.net/webOptimize/serviceWorker2.png" alt="from ServiceWorker" width="100%" title="from ServiceWorker" align="center"></p><p><img src="https://cdn.lishaoy.net/webOptimize/serviceWorker3.png" alt="Cache Storage" width="100%" title="Cache Storage" align="center"></p><p><img class="hidden" src="https://cdn.lishaoy.net/webOptimize/Optimize.png" alt="web optimize" width="100%" title="web optimize" align="center"></p><h2 id="未完，待续。。。-😜"><a href="#未完，待续。。。-😜" class="headerlink" title="未完，待续。。。 😜"></a>未完，待续。。。 😜</h2></div><div><div><div class="text-center line pages-end"> <span>本文结束<i class="fa fa-meh-o fa-fw"></i>感谢您的阅读</span></div></div></div><div><div class="my_post_copyright"><script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.staticfile.org/jquery/1.7.1/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/sweetalert@1.0.0/dist/sweetalert.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/sweetalert@1.0.0/dist/sweetalert.css"><p><span>本文标题:</span><a href="/webOptimize.html">前端性能优化</a></p><p><span>文章作者:</span><a href="/" title="访问 李少颖（persilee） 的个人博客">李少颖（persilee）</a></p><p><span>发布时间:</span>2018年05月10日 - 12:05</p><p><span>最后更新:</span>2018年11月05日 - 05:11</p><p><span>原始链接:</span><a href="/webOptimize.html" title="前端性能优化">https://www.h.lishaoy.net/webOptimize.html</a><span class="copy-path" title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="https://www.h.lishaoy.net/webOptimize.html" aria-label=" 复制成功！"></i></span></p><p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">署名-非商业性使用-禁止演绎 4.0 国际</a> 转载请保留原文链接及作者。</p></div><script>var clipboard=new Clipboard(".fa-clipboard");clipboard.on("success",$(function(){$(".fa-clipboard").click(function(){swal({title:"",text:"复制成功",timer:500,showConfirmButton:!1})})}))</script></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div>坚持原创技术分享，您的支持将鼓励我继续创作！</div> <button id="rewardButton" disable="enable" onclick='var qr=document.getElementById("QR");"none"===qr.style.display?qr.style.display="block":qr.style.display="none"'> <span>赏</span></button><div id="QR" style="display:none"><div id="wechat" style="display:inline-block"> <img id="wechat_qr" src="/images/wechatpay.jpg" alt="李少颖（persilee） WeChat Pay"><p>WeChat Pay</p></div><div id="alipay" style="display:inline-block"> <img id="alipay_qr" src="/images/alipay.jpg" alt="李少颖（persilee） Alipay"><p>Alipay</p></div></div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/性能优化/" rel="tag"><i class="fa fa-tag fa-fw"></i> 性能优化</a><a href="/tags/web/" rel="tag"><i class="fa fa-tag fa-fw"></i> web</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/createPromise.html" rel="next" title="Promise诞生记"><i class="fa fa-chevron-left"></i> Promise诞生记</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/baidustatistics.html" rel="prev" title="百度统计">百度统计<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div><div class="comments" id="comments"><div class="comments v" id="comments"></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview"> 站点概览</li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="https://cdn.lishaoy.net/images/lsy.png" alt="李少颖（persilee）"><p class="site-author-name" itemprop="name">李少颖（persilee）</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">18</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/index.html"><span class="site-state-item-count">10</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">37</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/rss2.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a rel="external nofollow" href="https://github.com/persilee" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a rel="external nofollow" href="https://twitter.com/persilee2" target="_blank" title="Twitter"><i class="fa fa-fw fa-twitter"></i> Twitter</a></span><span class="links-of-author-item"><a rel="external nofollow" href="https://segmentfault.com/u/lishaoy" target="_blank" title="segmentfault"><i class="fa fa-fw fa-globe"></i> segmentfault</a></span><span class="links-of-author-item"><a rel="external nofollow" href="https://juejin.im/user/58b3d788570c350069747887" target="_blank" title="掘金"><i class="fa fa-fw fa-globe"></i> 掘金</a></span><span class="links-of-author-item"><a rel="external nofollow" href="https://www.jianshu.com/u/8a1ceccf9714" target="_blank" title="简书"><i class="fa fa-fw fa-globe"></i> 简书</a></span><span class="links-of-author-item"><a rel="external nofollow" href="http://lishaoy.poco.cn" target="_blank" title="POCO"><i class="fa fa-fw fa-globe"></i> POCO</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-inline"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-globe"></i> 推荐阅读</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"> <a rel="external nofollow" href="http://callmesoul.cn" title="Callmesoul" target="_blank">Callmesoul</a></li></ul></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#压缩-合并"><span class="nav-number">1.</span> <span class="nav-text">压缩 合并</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#JS、CSS-压缩-合并"><span class="nav-number">1.1.</span> <span class="nav-text">JS、CSS 压缩 合并</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#图片压缩、合并"><span class="nav-number">1.2.</span> <span class="nav-text">图片压缩、合并</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#缓存"><span class="nav-number">2.</span> <span class="nav-text">缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#强缓存"><span class="nav-number">2.1.</span> <span class="nav-text">强缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#expires"><span class="nav-number">2.1.1.</span> <span class="nav-text">expires</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#cache-control"><span class="nav-number">2.1.2.</span> <span class="nav-text">cache-control</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#协商缓存"><span class="nav-number">2.2.</span> <span class="nav-text">协商缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Last-Modified-If-Modified-Since"><span class="nav-number">2.2.1.</span> <span class="nav-text">Last-Modified/If-Modified-Since</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Etag-If-None-Match"><span class="nav-number">2.2.2.</span> <span class="nav-text">Etag/If-None-Match</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Service-Worker"><span class="nav-number">2.3.</span> <span class="nav-text">Service Worker</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#什么是-Service-Worker"><span class="nav-number">2.3.1.</span> <span class="nav-text">什么是 Service Worker</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#生命周期"><span class="nav-number">2.3.2.</span> <span class="nav-text">生命周期</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#注册-service-worker"><span class="nav-number">2.3.3.</span> <span class="nav-text">注册 service worker</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#激活-service-worker"><span class="nav-number">2.3.4.</span> <span class="nav-text">激活 service worker</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#监听-service-worker"><span class="nav-number">2.3.5.</span> <span class="nav-text">监听 service worker</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#sw-toolbox"><span class="nav-number">2.3.6.</span> <span class="nav-text">sw-toolbox</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#未完，待续。。。-😜"><span class="nav-number">3.</span> <span class="nav-text">未完，待续。。。 😜</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2018</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">李少颖（persilee）</span></div><div class="powered-by"><i class="fa fa-users fa-fw"></i> <span id="busuanzi_container_site_uv">终于等到你(UV):<span id="busuanzi_value_site_uv"></span></span> &nbsp;&nbsp;|&nbsp;&nbsp;<i class="fa fa-bar-chart-o fa-fw"></i> <span id="busuanzi_container_site_pv">欢迎再来(PV):<span id="busuanzi_value_site_pv"></span></span><div class="theme-info"><div class="powered-by"></div> <span class="post-count">Blog总字数: 26.3k字</span></div></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="https://cdn.lishaoy.net/js/index.js"></script><script src="https://cdn.lishaoy.net/js/av-min.js"></script><script src="https://cdn.lishaoy.net/js/Valine.min-2d948fjf6gj4hf.js"></script><script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = '';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        av: AV,
        el: '#comments' ,
        appId: 'aYLp6FBYzOGMYTUMR9qtvO3G-gzGzoHsz',
        appKey: 'LQGYiMkEyJ6VYOba5K0LvduD',
        placeholder: '想说点什么 ：）',
        avatar: 'retro'
    });
  </script><script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.json";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script><script src="https://cdn.lishaoy.net/js/av-core-mini-0.6.4.js"></script><script>AV.initialize("aYLp6FBYzOGMYTUMR9qtvO3G-gzGzoHsz","LQGYiMkEyJ6VYOba5K0LvduD")</script><script>function showTime(e){var t=new AV.Query(e),c=[],u=$(".leancloud_visitors");u.each(function(){c.push($(this).attr("id").trim())}),t.containedIn("url",c),t.find().done(function(e){var t=".leancloud-visitors-count";if(0!==e.length){for(var n=0;n<e.length;n++){var o=e[n],i=o.get("url"),s=o.get("time"),r=document.getElementById(i);$(r).find(t).text(s)}for(n=0;n<c.length;n++){i=c[n],r=document.getElementById(i);var l=$(r).find(t);""==l.text()&&l.text(0)}}else u.find(t).text(0)}).fail(function(e,t){console.log("Error: "+t.code+" "+t.message)})}function addCount(i){var e=$(".leancloud_visitors"),s=e.attr("id").trim(),r=e.attr("data-flag-title").trim(),t=new AV.Query(i);t.equalTo("url",s),t.find({success:function(e){if(0<e.length){var t=e[0];t.fetchWhenSave(!0),t.increment("time"),t.save(null,{success:function(e){$(document.getElementById(s)).find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to save Visitor num, with error message: "+t.message)}})}else{var n=new i,o=new AV.ACL;o.setPublicReadAccess(!0),o.setPublicWriteAccess(!0),n.setACL(o),n.set("title",r),n.set("url",s),n.set("time",1),n.save(null,{success:function(e){$(document.getElementById(s)).find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to create")}})}},error:function(e){console.log("Error:"+e.code+" "+e.message)}})}$(function(){var e=AV.Object.extend("Counter");1==$(".leancloud_visitors").length?addCount(e):1<$(".post-title-link").length&&showTime(e)})</script><script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script><script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script><script type="text/javascript" src=""></script><div id="load" style=""></div><script type="text/javascript" src="https://cdn.lishaoy.net/js/all-min-6da1d90143.js"></script><script src="/video/video.js"></script><script>$(function(){$("#loader").css("display","none")})</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-120619444-1"></script><style>.comments.no-post{background:0 0}.no-post.v *{color:#ddd}.v .vlist p{margin:12px 0}.v .vbtn{background:#fbfbfb;padding:.3rem 1.2em;border:1px solid #dddddd75}.no-post.v .vbtn{background:#2222220a}.no-post.v .vbtn:active,.no-post.v .vbtn:hover{background-color:#fff}.no-post.v .vwrap{border:1px solid #f0f0f036}.no-post.v a{color:#ddd}.v ul{padding-left:25px}.v ul li{list-style:disc;padding:2px 15px 0 0}.v .vlist strong,.vinput.vpreview strong{color:#87daff;font-size:108%}.v .vlist .vcard .vhead .vsys{background:#87daff17;color:#aaa;border:1px solid #87daff1f;padding:1px 5px;font-size:12px;line-height:1.4}.no-post.v .vlist .vcard .vhead .vsys{background:#ededed1f;color:grey;padding:1px 5px;font-size:12px;line-height:1.4;border:none}.v .vlist .vcard .vcontent a{color:#86dbff;border-bottom-color:#86dbff99}.v .vlist .vcard .vcontent a:hover{color:#d7191a;border-bottom-color:#222}.no-post.v .vlist .vcard section{border-bottom:1px dashed #f5f5f55e}.v .vwrap .vheader .vinput{width:33.33%;border-bottom:1px dashed #dedede45}.no-post.v .vwrap .vheader .vinput::-webkit-input-placeholder{color:grey}.no-post.v .vwrap .vheader .vinput:-ms-input-placeholder{color:grey}.v .txt-right{display:none}.v .vlist .vcard .vcontent .code,.v .vlist .vcard .vcontent code,.v .vlist .vcard .vcontent pre,.vinput.vpreview code,.vinput.vpreview pre{color:#005098fc;background:#87daffb8;border-radius:4px;box-shadow:0 0 2px #87daff;font-size:90%;padding:2px 6px}.v .vlist .vcard .vcontent img{display:inline-block}.v .vwrap .vheader .vinput:focus{border-bottom:1px solid #87daff}.v .vlist .vcard .vcontent pre,.vinput.vpreview pre{background:#87daff21;border-radius:4px;box-shadow:0 0 2px #ffffff33}.v .vlist .vcard .vcontent pre code,.vinput.vpreview pre code{color:#005098e3;background:#87daff00;border-radius:4px;box-shadow:0 0 2px #87daff05}.comments.no-post .vinput.vpreview pre code,.comments.no-post .vlist .vcard .vcontent pre code{color:#7fd3f9}.v .vlist .vcard .vcontent.expand:after{color:#ff0000de;font-size:110%;font-weight:700;background:#87daff38;border-bottom-right-radius:4px;border-bottom-left-radius:4px}.comments.no-post .vlist .vcard .vcontent.expand:after{color:#fff}@media screen and (max-width:414px){.v .vlist{padding-left:0}}@media screen and (max-width:520px){.v .vlist .vcard .vhead .vsys{display:inline-block}}.v .vlist .vcard .vcontent.expand:before{background:linear-gradient(180deg,hsla(0,0%,100%,0),hsla(199,100%,76%,.22));background:-webkit-gradient(linear,left top,left bottom,from(hsla(0,0%,100%,0)),to(hsla(199,100%,76%,.22));}</style></body></html>